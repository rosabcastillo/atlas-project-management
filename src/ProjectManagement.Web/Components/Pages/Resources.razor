@page "/resources"
@using Microsoft.EntityFrameworkCore
@using ProjectManagement.Infrastructure.Data
@using ProjectManagement.Domain.Entities
@using ProjectManagement.Domain.Enums
@inject AppDbContext DbContext
@rendermode InteractiveServer

<PageTitle>Resources - Nova</PageTitle>

<div class="page-header">
    <div>
        <h1 class="page-title">Resources</h1>
        <p class="page-subtitle">Manage your team members and their skills</p>
    </div>
    <div class="page-header-actions">
        <button class="btn btn-secondary" @onclick="OpenImportModal">Import Leaves</button>
        <button class="btn btn-primary" @onclick="OpenAddModal">+ Add Resource</button>
    </div>
</div>

<div class="glass-card">
    <div class="action-bar">
        <div class="action-bar-left">
            <div class="search-box">
                <input type="text" class="form-control" placeholder="Search resources..." @bind="searchTerm" @bind:event="oninput" @bind:after="ResetPage" />
            </div>
            <select class="form-control w-auto" @bind="filterRoleId" @bind:after="ResetPage">
                <option value="0">All Roles</option>
                @foreach (var role in roles)
                {
                    <option value="@role.Id">@role.Name</option>
                }
            </select>
            <select class="form-control w-auto" @bind="filterVendorId" @bind:after="ResetPage">
                <option value="0">All Vendors</option>
                <option value="-1">No Vendor</option>
                @foreach (var vendor in vendors)
                {
                    <option value="@vendor.Id">@vendor.Name</option>
                }
            </select>
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th class="sortable @(GetSortClass("Name"))" @onclick='() => SetSort("Name")' aria-sort="@(DisplayHelpers.GetAriaSort(sortColumn, sortAscending, "Name"))">Name</th>
                    <th class="sortable @(GetSortClass("Role"))" @onclick='() => SetSort("Role")' aria-sort="@(DisplayHelpers.GetAriaSort(sortColumn, sortAscending, "Role"))">Role</th>
                    <th class="sortable @(GetSortClass("Vendor"))" @onclick='() => SetSort("Vendor")' aria-sort="@(DisplayHelpers.GetAriaSort(sortColumn, sortAscending, "Vendor"))">Vendor</th>
                    <th>Skills</th>
                    <th class="sortable @(GetSortClass("EndDate"))" @onclick='() => SetSort("EndDate")' aria-sort="@(DisplayHelpers.GetAriaSort(sortColumn, sortAscending, "EndDate"))">End Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var resource in PagedResources)
                {
                    var isTerminated = resource.EndDate.HasValue && resource.EndDate.Value < DateTime.Today;
                    <tr class="@(isTerminated ? "row-terminated" : "")">
                        <td>
                            <strong>@resource.Name</strong>
                            @if (isTerminated)
                            {
                                <span class="badge badge-danger badge-sm" style="margin-left: 0.5rem;">Terminated</span>
                            }
                        </td>
                        <td>
                            <span class="badge @(resource.Role.RequiresCapacity ? "badge-primary" : "badge-secondary")">
                                @resource.Role.Name
                            </span>
                        </td>
                        <td>@(resource.Vendor?.Name ?? "-")</td>
                        <td>
                            <div class="skill-tags">
                                @foreach (var rs in resource.ResourceSkills.Take(3))
                                {
                                    <span class="skill-tag">@rs.Skill.Name</span>
                                }
                                @if (resource.ResourceSkills.Count > 3)
                                {
                                    <span class="skill-tag">+@(resource.ResourceSkills.Count - 3)</span>
                                }
                            </div>
                        </td>
                        <td>
                            @if (resource.EndDate.HasValue)
                            {
                                <span class="@(isTerminated ? "text-danger" : "")">@resource.EndDate.Value.ToString("MMM dd, yyyy")</span>
                            }
                            else
                            {
                                <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            <button class="btn btn-secondary btn-sm" @onclick="() => OpenEditModal(resource)">Edit</button>
                            <button class="btn btn-secondary btn-sm" @onclick="() => OpenUnavailabilityModal(resource)">Unavailability</button>
                            <button class="btn btn-danger btn-sm" @onclick="() => ConfirmDeleteResource(resource)">Delete</button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <PaginationBar CurrentPage="currentPage" PageSize="pageSize" TotalCount="TotalCount" OnPageChanged="GoToPage" />
</div>

@if (showModal)
{
    <div class="modal-backdrop" @onclick="CloseModal">
        <div class="modal" @onclick:stopPropagation="true" role="dialog" aria-labelledby="modal-title-resource">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title-resource">@(isEditing ? "Edit Resource" : "Add Resource")</h3>
                <button class="modal-close" @onclick="CloseModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Name *</label>
                    <input type="text" class="form-control" @bind="currentResource.Name" />
                    @if (!string.IsNullOrEmpty(resourceError))
                    {
                        <div class="text-danger field-validation-error">@resourceError</div>
                    }
                </div>
                <div class="form-group">
                    <label class="form-label">Role *</label>
                    <select class="form-control" @bind="selectedRoleId">
                        <option value="0">Select a role...</option>
                        @foreach (var role in roles)
                        {
                            <option value="@role.Id">@role.Name</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Vendor</label>
                    <select class="form-control" @bind="selectedVendorId">
                        <option value="0">None</option>
                        @foreach (var vendor in vendors)
                        {
                            <option value="@vendor.Id">@vendor.Name</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-control" @bind="currentResource.EndDate" />
                </div>
                <div class="form-group">
                    <label class="form-label">Skills</label>
                    <div class="skill-tags">
                        @foreach (var skill in skills)
                        {
                            <span class="skill-tag @(selectedSkillIds.Contains(skill.Id) ? "selected" : "")"
                                  @onclick="() => ToggleSkill(skill.Id)">
                                @skill.Name
                            </span>
                        }
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                <button class="btn btn-primary" @onclick="SaveResource">Save</button>
            </div>
        </div>
    </div>
}

@if (showUnavailabilityModal && unavailabilityResource != null)
{
    <div class="modal-backdrop" @onclick="CloseUnavailabilityModal">
        <div class="modal modal-lg" @onclick:stopPropagation="true" role="dialog" aria-labelledby="modal-title-unavailability">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title-unavailability">Manage Unavailability - @unavailabilityResource.Name</h3>
                <button class="modal-close" @onclick="CloseUnavailabilityModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="unavailability-form">
                    <h4>@(isEditingUnavailability ? "Edit Unavailability" : "Add Unavailability")</h4>
                    @if (!string.IsNullOrEmpty(unavailabilityError))
                    {
                        <div class="alert alert-error">@unavailabilityError</div>
                    }
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">From Date *</label>
                            <input type="date" class="form-control" @bind="currentUnavailability.StartDate" />
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">To Date *</label>
                            <input type="date" class="form-control" @bind="currentUnavailability.EndDate" />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group flex-1">
                            <label class="form-label">Hours per day</label>
                            <select class="form-control" @bind="currentUnavailability.Hours">
                                <option value="8">8 (Full day)</option>
                                <option value="7">7</option>
                                <option value="6">6</option>
                                <option value="5">5</option>
                                <option value="4">4 (Half day)</option>
                                <option value="3">3</option>
                                <option value="2">2</option>
                                <option value="1">1</option>
                            </select>
                        </div>
                        <div class="form-group flex-1">
                            <label class="form-label">Reason</label>
                            <select class="form-control" @bind="currentUnavailability.Reason">
                                @foreach (var reason in Enum.GetValues<UnavailabilityReason>())
                                {
                                    <option value="@reason">@DisplayHelpers.GetReasonDisplayName(reason)</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <input type="text" class="form-control" @bind="currentUnavailability.Notes" placeholder="Optional notes..." />
                    </div>
                    <div class="form-actions">
                        @if (isEditingUnavailability)
                        {
                            <button class="btn btn-secondary btn-sm" @onclick="CancelEditUnavailability">Cancel</button>
                        }
                        <button class="btn btn-primary btn-sm" @onclick="SaveUnavailability">
                            @(isEditingUnavailability ? "Update" : "Add")
                        </button>
                    </div>
                </div>

                @if (resourceUnavailabilities.Any())
                {
                    <div class="unavailability-list">
                        <h4>Existing Unavailabilities</h4>
                        <div class="unavailability-items">
                            @foreach (var u in resourceUnavailabilities.OrderByDescending(x => x.StartDate))
                            {
                                <div class="unavailability-item">
                                    <div class="unavailability-info">
                                        <span class="unavailability-dates">
                                            @u.StartDate.ToString("MMM dd, yyyy")
                                            @if (u.StartDate != u.EndDate)
                                            {
                                                <span> - @u.EndDate.ToString("MMM dd, yyyy")</span>
                                            }
                                        </span>
                                        <span class="badge @GetReasonBadgeClass(u.Reason)">@DisplayHelpers.GetReasonDisplayName(u.Reason)</span>
                                        <span class="unavailability-hours">@u.Hours h/day</span>
                                        @if (!string.IsNullOrWhiteSpace(u.Notes))
                                        {
                                            <span class="unavailability-notes">@u.Notes</span>
                                        }
                                    </div>
                                    <div class="unavailability-actions">
                                        <button class="btn btn-secondary btn-sm" @onclick="() => EditUnavailability(u)">Edit</button>
                                        <button class="btn btn-danger btn-sm" @onclick="() => ConfirmDeleteUnavailability(u)">Delete</button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseUnavailabilityModal">Close</button>
            </div>
        </div>
    </div>
}

@if (showImportModal)
{
    <div class="modal-backdrop" @onclick="CloseImportModal">
        <div class="modal modal-lg" @onclick:stopPropagation="true" role="dialog" aria-labelledby="modal-title-import">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title-import">Import Leaves from CSV</h3>
                <button class="modal-close" @onclick="CloseImportModal">&times;</button>
            </div>
            <div class="modal-body">
                @if (string.IsNullOrEmpty(importError) == false)
                {
                    <div class="alert alert-error">@importError</div>
                }

                @if (importPreviewData.Count == 0)
                {
                    <div class="import-instructions">
                        <p><strong>CSV Format:</strong></p>
                        <code>ResourceName,StartDate,EndDate,Hours,Reason,Notes</code>
                        <p style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                            <strong>Reason values:</strong> PTO, Holiday, SickLeave, Other<br/>
                            <strong>Hours:</strong> 1-8 (8 = full day)<br/>
                            <strong>Date format:</strong> YYYY-MM-DD
                        </p>
                        <div class="form-group" style="margin-top: 1rem;">
                            <label class="form-label">Select CSV File</label>
                            <InputFile OnChange="HandleFileSelected" accept=".csv" class="form-control" />
                        </div>
                    </div>
                }
                else
                {
                    <div class="import-preview">
                        <p><strong>Preview:</strong> @importPreviewData.Count row(s) found, @importPreviewData.Count(r => r.IsValid) valid</p>
                        <div class="import-preview-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Status</th>
                                        <th>Resource</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Hours</th>
                                        <th>Reason</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var row in importPreviewData)
                                    {
                                        <tr class="@(row.IsValid ? "" : "row-error")">
                                            <td>
                                                @if (row.IsValid)
                                                {
                                                    <span class="badge badge-success">Valid</span>
                                                }
                                                else
                                                {
                                                    <span class="badge badge-danger" title="@row.ErrorMessage">Error</span>
                                                }
                                            </td>
                                            <td>@row.ResourceName</td>
                                            <td>@row.StartDate?.ToString("MMM dd, yyyy")</td>
                                            <td>@row.EndDate?.ToString("MMM dd, yyyy")</td>
                                            <td>@row.Hours</td>
                                            <td>@row.Reason</td>
                                            <td>@row.Notes</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        @if (importPreviewData.Any(r => !r.IsValid))
                        {
                            <div class="import-errors">
                                <p><strong>Errors:</strong></p>
                                <ul>
                                    @foreach (var row in importPreviewData.Where(r => !r.IsValid))
                                    {
                                        <li>Row @(importPreviewData.IndexOf(row) + 1): @row.ErrorMessage</li>
                                    }
                                </ul>
                            </div>
                        }
                    </div>
                }
            </div>
            <div class="modal-footer">
                @if (importPreviewData.Count > 0)
                {
                    <button class="btn btn-secondary" @onclick="ResetImport">Back</button>
                    <button class="btn btn-primary" @onclick="ConfirmImport" disabled="@(!importPreviewData.Any(r => r.IsValid))">
                        Import @importPreviewData.Count(r => r.IsValid) Valid Row(s)
                    </button>
                }
                else
                {
                    <button class="btn btn-secondary" @onclick="CloseImportModal">Cancel</button>
                }
            </div>
        </div>
    </div>
}

<ConfirmDeleteModal Visible="showDeleteResourceConfirm"
    Message="@($"Are you sure you want to delete resource \"{resourceToDelete?.Name}\"? This will also delete all their allocations and unavailability records.")"
    OnConfirm="DeleteResource"
    OnCancel="CancelDeleteResource" />

<ConfirmDeleteModal Visible="showDeleteUnavailabilityConfirm"
    Message="@("Are you sure you want to delete this unavailability record?")"
    OnConfirm="DeleteUnavailability"
    OnCancel="CancelDeleteUnavailability" />

@code {
    private List<Resource> resources = new();
    private List<Role> roles = new();
    private List<Vendor> vendors = new();
    private List<Skill> skills = new();
    private string searchTerm = "";
    private int filterRoleId = 0;
    private int filterVendorId = 0;
    private bool showModal = false;
    private bool isEditing = false;
    private Resource currentResource = new();
    private int selectedRoleId = 0;
    private int selectedVendorId = 0;
    private HashSet<int> selectedSkillIds = new();

    // Delete confirmations
    private bool showDeleteResourceConfirm = false;
    private Resource? resourceToDelete = null;
    private bool showDeleteUnavailabilityConfirm = false;
    private ResourceUnavailability? unavailabilityToDelete = null;

    // Unavailability management
    private bool showUnavailabilityModal = false;
    private Resource? unavailabilityResource = null;
    private List<ResourceUnavailability> resourceUnavailabilities = new();

    // Import functionality
    private bool showImportModal = false;
    private string? importError = null;
    private List<ImportRowData> importPreviewData = new();
    private ResourceUnavailability currentUnavailability = new();
    private bool isEditingUnavailability = false;
    private string? unavailabilityError = null;
    private string? resourceError = null;

    // Pagination & Sorting
    private int currentPage = 1;
    private int pageSize = 10;
    private string sortColumn = "Name";
    private bool sortAscending = true;

    private IEnumerable<Resource> FilteredResources
    {
        get
        {
            var filtered = resources.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(searchTerm))
                filtered = filtered.Where(r => r.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

            if (filterRoleId > 0)
                filtered = filtered.Where(r => r.RoleId == filterRoleId);

            if (filterVendorId == -1)
                filtered = filtered.Where(r => r.VendorId == null);
            else if (filterVendorId > 0)
                filtered = filtered.Where(r => r.VendorId == filterVendorId);

            return filtered;
        }
    }

    private IEnumerable<Resource> SortedResources
    {
        get
        {
            var data = FilteredResources;
            return sortColumn switch
            {
                "Name" => sortAscending ? data.OrderBy(r => r.Name) : data.OrderByDescending(r => r.Name),
                "Role" => sortAscending ? data.OrderBy(r => r.Role.Name) : data.OrderByDescending(r => r.Role.Name),
                "Vendor" => sortAscending ? data.OrderBy(r => r.Vendor?.Name ?? "zzz") : data.OrderByDescending(r => r.Vendor?.Name ?? ""),
                "EndDate" => sortAscending ? data.OrderBy(r => r.EndDate ?? DateTime.MaxValue) : data.OrderByDescending(r => r.EndDate ?? DateTime.MinValue),
                _ => data.OrderBy(r => r.Name)
            };
        }
    }

    private IEnumerable<Resource> PagedResources => SortedResources.Skip((currentPage - 1) * pageSize).Take(pageSize);
    private int TotalCount => FilteredResources.Count();

    private void SetSort(string column)
    {
        if (sortColumn == column)
            sortAscending = !sortAscending;
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
        currentPage = 1;
    }

    private string GetSortClass(string column) => sortColumn == column ? (sortAscending ? "asc" : "desc") : "";

    private void GoToPage(int pg) => currentPage = pg;
    private void ResetPage() => currentPage = 1;

    protected override async Task OnInitializedAsync()
    {
        roles = await DbContext.Roles.OrderBy(r => r.Name).ToListAsync();
        vendors = await DbContext.Vendors.OrderBy(v => v.Name).ToListAsync();
        skills = await DbContext.Skills.OrderBy(s => s.Name).ToListAsync();
        await LoadResources();
    }

    private async Task LoadResources()
    {
        resources = await DbContext.Resources
            .Include(r => r.Role)
            .Include(r => r.Vendor)
            .Include(r => r.ResourceSkills).ThenInclude(rs => rs.Skill)
            .ToListAsync();
    }

    private void OpenAddModal()
    {
        currentResource = new Resource();
        selectedRoleId = 0;
        selectedVendorId = 0;
        selectedSkillIds = new HashSet<int>();
        isEditing = false;
        resourceError = null;
        showModal = true;
    }

    private void OpenEditModal(Resource resource)
    {
        currentResource = new Resource { Id = resource.Id, Name = resource.Name, RoleId = resource.RoleId, VendorId = resource.VendorId, EndDate = resource.EndDate };
        selectedRoleId = resource.RoleId;
        selectedVendorId = resource.VendorId ?? 0;
        selectedSkillIds = resource.ResourceSkills.Select(rs => rs.SkillId).ToHashSet();
        isEditing = true;
        resourceError = null;
        showModal = true;
    }

    private void CloseModal() { resourceError = null; showModal = false; }

    private void ToggleSkill(int skillId)
    {
        if (selectedSkillIds.Contains(skillId)) selectedSkillIds.Remove(skillId);
        else selectedSkillIds.Add(skillId);
    }

    private async Task SaveResource()
    {
        resourceError = null;
        if (string.IsNullOrWhiteSpace(currentResource.Name) || selectedRoleId == 0) return;

        var nameToCheck = currentResource.Name.Trim().ToLower();
        var duplicate = await DbContext.Resources
            .AnyAsync(r => r.Name.ToLower() == nameToCheck && (!isEditing || r.Id != currentResource.Id));
        if (duplicate)
        {
            resourceError = "A resource with this name already exists.";
            return;
        }

        currentResource.RoleId = selectedRoleId;
        currentResource.VendorId = selectedVendorId == 0 ? null : selectedVendorId;

        if (isEditing)
        {
            var existing = await DbContext.Resources.Include(r => r.ResourceSkills).FirstOrDefaultAsync(r => r.Id == currentResource.Id);
            if (existing != null)
            {
                existing.Name = currentResource.Name;
                existing.RoleId = currentResource.RoleId;
                existing.VendorId = currentResource.VendorId;
                existing.EndDate = currentResource.EndDate;
                DbContext.ResourceSkills.RemoveRange(existing.ResourceSkills);
                foreach (var skillId in selectedSkillIds)
                    DbContext.ResourceSkills.Add(new ResourceSkill { ResourceId = existing.Id, SkillId = skillId });
                await DbContext.SaveChangesAsync();
            }
        }
        else
        {
            DbContext.Resources.Add(currentResource);
            await DbContext.SaveChangesAsync();
            foreach (var skillId in selectedSkillIds)
                DbContext.ResourceSkills.Add(new ResourceSkill { ResourceId = currentResource.Id, SkillId = skillId });
            await DbContext.SaveChangesAsync();
        }

        await LoadResources();
        CloseModal();
    }

    private void ConfirmDeleteResource(Resource resource)
    {
        resourceToDelete = resource;
        showDeleteResourceConfirm = true;
    }

    private void CancelDeleteResource()
    {
        resourceToDelete = null;
        showDeleteResourceConfirm = false;
    }

    private async Task DeleteResource()
    {
        if (resourceToDelete == null) return;
        DbContext.Resources.Remove(resourceToDelete);
        await DbContext.SaveChangesAsync();
        resourceToDelete = null;
        showDeleteResourceConfirm = false;
        await LoadResources();
    }

    // Unavailability management methods
    private async Task OpenUnavailabilityModal(Resource resource)
    {
        unavailabilityResource = resource;
        await LoadResourceUnavailabilities();
        ResetUnavailabilityForm();
        showUnavailabilityModal = true;
    }

    private void CloseUnavailabilityModal()
    {
        showUnavailabilityModal = false;
        unavailabilityResource = null;
        resourceUnavailabilities.Clear();
    }

    private async Task LoadResourceUnavailabilities()
    {
        if (unavailabilityResource == null) return;
        resourceUnavailabilities = await DbContext.ResourceUnavailabilities
            .Where(u => u.ResourceId == unavailabilityResource.Id)
            .ToListAsync();
    }

    private void ResetUnavailabilityForm()
    {
        currentUnavailability = new ResourceUnavailability
        {
            StartDate = DateTime.Today,
            EndDate = DateTime.Today,
            Hours = 8,
            Reason = UnavailabilityReason.PTO
        };
        isEditingUnavailability = false;
        unavailabilityError = null;
    }

    private void EditUnavailability(ResourceUnavailability u)
    {
        currentUnavailability = new ResourceUnavailability
        {
            Id = u.Id,
            ResourceId = u.ResourceId,
            StartDate = u.StartDate,
            EndDate = u.EndDate,
            Hours = u.Hours,
            Reason = u.Reason,
            Notes = u.Notes
        };
        isEditingUnavailability = true;
    }

    private void CancelEditUnavailability()
    {
        ResetUnavailabilityForm();
    }

    private async Task SaveUnavailability()
    {
        unavailabilityError = null;

        if (unavailabilityResource == null) return;

        // Validate dates
        if (currentUnavailability.StartDate > currentUnavailability.EndDate)
        {
            unavailabilityError = "End date must be on or after the start date.";
            return;
        }

        // Validate hours
        if (currentUnavailability.Hours < 1 || currentUnavailability.Hours > 8)
        {
            unavailabilityError = "Hours must be between 1 and 8.";
            return;
        }

        // Check for overlapping periods
        var overlapping = resourceUnavailabilities
            .Where(u => isEditingUnavailability ? u.Id != currentUnavailability.Id : true)
            .Where(u => currentUnavailability.StartDate <= u.EndDate && currentUnavailability.EndDate >= u.StartDate)
            .FirstOrDefault();

        if (overlapping != null)
        {
            unavailabilityError = $"This period overlaps with existing unavailability ({overlapping.StartDate:MMM dd} - {overlapping.EndDate:MMM dd, yyyy}).";
            return;
        }

        if (isEditingUnavailability)
        {
            var existing = await DbContext.ResourceUnavailabilities.FindAsync(currentUnavailability.Id);
            if (existing != null)
            {
                existing.StartDate = currentUnavailability.StartDate;
                existing.EndDate = currentUnavailability.EndDate;
                existing.Hours = currentUnavailability.Hours;
                existing.Reason = currentUnavailability.Reason;
                existing.Notes = currentUnavailability.Notes;
                await DbContext.SaveChangesAsync();
            }
        }
        else
        {
            var newUnavailability = new ResourceUnavailability
            {
                ResourceId = unavailabilityResource.Id,
                StartDate = currentUnavailability.StartDate,
                EndDate = currentUnavailability.EndDate,
                Hours = currentUnavailability.Hours,
                Reason = currentUnavailability.Reason,
                Notes = currentUnavailability.Notes
            };
            DbContext.ResourceUnavailabilities.Add(newUnavailability);
            await DbContext.SaveChangesAsync();
        }

        await LoadResourceUnavailabilities();
        ResetUnavailabilityForm();
    }

    private void ConfirmDeleteUnavailability(ResourceUnavailability u)
    {
        unavailabilityToDelete = u;
        showDeleteUnavailabilityConfirm = true;
    }

    private void CancelDeleteUnavailability()
    {
        unavailabilityToDelete = null;
        showDeleteUnavailabilityConfirm = false;
    }

    private async Task DeleteUnavailability()
    {
        if (unavailabilityToDelete == null) return;
        var existing = await DbContext.ResourceUnavailabilities.FindAsync(unavailabilityToDelete.Id);
        if (existing != null)
        {
            DbContext.ResourceUnavailabilities.Remove(existing);
            await DbContext.SaveChangesAsync();
            await LoadResourceUnavailabilities();
        }
        unavailabilityToDelete = null;
        showDeleteUnavailabilityConfirm = false;
    }

    private string GetReasonBadgeClass(UnavailabilityReason reason) => reason switch
    {
        UnavailabilityReason.PTO => "badge-pto",
        UnavailabilityReason.Holiday => "badge-holiday",
        UnavailabilityReason.SickLeave => "badge-sick",
        UnavailabilityReason.Other => "badge-other",
        _ => "badge-secondary"
    };

    // Import methods
    private void OpenImportModal()
    {
        importError = null;
        importPreviewData.Clear();
        showImportModal = true;
    }

    private void CloseImportModal()
    {
        showImportModal = false;
        importError = null;
        importPreviewData.Clear();
    }

    private void ResetImport()
    {
        importError = null;
        importPreviewData.Clear();
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        importError = null;
        importPreviewData.Clear();

        try
        {
            var file = e.File;
            if (file == null)
            {
                importError = "No file selected.";
                return;
            }

            if (!file.Name.EndsWith(".csv", StringComparison.OrdinalIgnoreCase))
            {
                importError = "Please select a CSV file.";
                return;
            }

            using var stream = file.OpenReadStream(maxAllowedSize: 1024 * 1024); // 1MB max
            using var reader = new System.IO.StreamReader(stream);
            var content = await reader.ReadToEndAsync();

            var lines = content.Split('\n', StringSplitOptions.RemoveEmptyEntries);
            if (lines.Length < 2)
            {
                importError = "CSV file must have a header row and at least one data row.";
                return;
            }

            // Skip header row
            for (int i = 1; i < lines.Length; i++)
            {
                var line = lines[i].Trim();
                if (string.IsNullOrWhiteSpace(line)) continue;

                var row = ParseCsvRow(line, i);
                importPreviewData.Add(row);
            }

            if (importPreviewData.Count == 0)
            {
                importError = "No valid data rows found in the CSV file.";
            }
        }
        catch (Exception ex)
        {
            importError = $"Error reading file: {ex.Message}";
        }
    }

    private ImportRowData ParseCsvRow(string line, int rowNumber)
    {
        var row = new ImportRowData();
        var parts = SplitCsvLine(line);

        if (parts.Length < 4)
        {
            row.ErrorMessage = "Not enough columns. Expected: ResourceName,StartDate,EndDate,Hours,Reason,Notes";
            return row;
        }

        row.ResourceName = parts[0].Trim();

        // Find resource
        var resource = resources.FirstOrDefault(r =>
            r.Name.Equals(row.ResourceName, StringComparison.OrdinalIgnoreCase));

        if (resource == null)
        {
            row.ErrorMessage = $"Resource '{row.ResourceName}' not found.";
            return row;
        }
        row.ResourceId = resource.Id;

        // Parse start date
        if (!DateTime.TryParse(parts[1].Trim(), out var startDate))
        {
            row.ErrorMessage = $"Invalid start date: {parts[1]}";
            return row;
        }
        row.StartDate = startDate;

        // Parse end date
        if (!DateTime.TryParse(parts[2].Trim(), out var endDate))
        {
            row.ErrorMessage = $"Invalid end date: {parts[2]}";
            return row;
        }
        row.EndDate = endDate;

        if (row.StartDate > row.EndDate)
        {
            row.ErrorMessage = "Start date must be before or equal to end date.";
            return row;
        }

        // Parse hours
        if (parts.Length > 3 && !string.IsNullOrWhiteSpace(parts[3]))
        {
            if (int.TryParse(parts[3].Trim(), out var hours) && hours >= 1 && hours <= 8)
            {
                row.Hours = hours;
            }
            else
            {
                row.ErrorMessage = $"Invalid hours: {parts[3]}. Must be 1-8.";
                return row;
            }
        }

        // Parse reason
        if (parts.Length > 4 && !string.IsNullOrWhiteSpace(parts[4]))
        {
            var reasonStr = parts[4].Trim();
            if (Enum.TryParse<UnavailabilityReason>(reasonStr, true, out var reason))
            {
                row.Reason = reason;
            }
            else
            {
                row.ErrorMessage = $"Invalid reason: {reasonStr}. Use: PTO, Holiday, SickLeave, or Other.";
                return row;
            }
        }

        // Parse notes
        if (parts.Length > 5)
        {
            row.Notes = parts[5].Trim();
        }

        // Check for overlapping unavailabilities
        var existingUnavailabilities = DbContext.ResourceUnavailabilities
            .Where(u => u.ResourceId == row.ResourceId)
            .AsEnumerable()
            .Where(u => row.StartDate <= u.EndDate && row.EndDate >= u.StartDate)
            .FirstOrDefault();

        if (existingUnavailabilities != null)
        {
            row.ErrorMessage = $"Overlaps with existing unavailability ({existingUnavailabilities.StartDate:MMM dd} - {existingUnavailabilities.EndDate:MMM dd}).";
            return row;
        }

        row.IsValid = true;
        return row;
    }

    private string[] SplitCsvLine(string line)
    {
        var result = new List<string>();
        var current = new System.Text.StringBuilder();
        bool inQuotes = false;

        foreach (var c in line)
        {
            if (c == '"')
            {
                inQuotes = !inQuotes;
            }
            else if (c == ',' && !inQuotes)
            {
                result.Add(current.ToString());
                current.Clear();
            }
            else
            {
                current.Append(c);
            }
        }
        result.Add(current.ToString());

        return result.ToArray();
    }

    private async Task ConfirmImport()
    {
        var validRows = importPreviewData.Where(r => r.IsValid).ToList();

        foreach (var row in validRows)
        {
            var unavailability = new ResourceUnavailability
            {
                ResourceId = row.ResourceId!.Value,
                StartDate = row.StartDate!.Value,
                EndDate = row.EndDate!.Value,
                Hours = row.Hours,
                Reason = row.Reason,
                Notes = row.Notes
            };
            DbContext.ResourceUnavailabilities.Add(unavailability);
        }

        await DbContext.SaveChangesAsync();
        CloseImportModal();
    }

    private class ImportRowData
    {
        public string ResourceName { get; set; } = "";
        public int? ResourceId { get; set; }
        public DateTime? StartDate { get; set; }
        public DateTime? EndDate { get; set; }
        public int Hours { get; set; } = 8;
        public UnavailabilityReason Reason { get; set; } = UnavailabilityReason.PTO;
        public string? Notes { get; set; }
        public bool IsValid { get; set; } = false;
        public string? ErrorMessage { get; set; }
    }
}
