@page "/calendar"
@using Microsoft.EntityFrameworkCore
@using ProjectManagement.Infrastructure.Data
@using ProjectManagement.Domain.Entities
@using ProjectManagement.Domain.Enums
@inject AppDbContext DbContext
@rendermode InteractiveServer

<PageTitle>Calendar - Atlas</PageTitle>

<div class="page-header">
    <div>
        <h1 class="page-title">Calendar</h1>
        <p class="page-subtitle">Monthly view of resource and project allocations</p>
    </div>
</div>

<div class="glass-card">
    <div class="action-bar">
        <div class="action-bar-left">
            <div class="view-toggle">
                <button class="view-toggle-btn @(viewMode == "Resource" ? "active" : "")" @onclick='() => SetViewMode("Resource")'>
                    By Resource
                </button>
                <button class="view-toggle-btn @(viewMode == "Project" ? "active" : "")" @onclick='() => SetViewMode("Project")'>
                    By Project
                </button>
            </div>

            @if (viewMode == "Resource")
            {
                <select class="form-control" style="width: 220px;" @bind="selectedResourceId" @bind:after="OnSelectionChanged">
                    <option value="0">Select a resource...</option>
                    @foreach (var resource in resources)
                    {
                        <option value="@resource.Id">@resource.Name (@resource.Role.Name)</option>
                    }
                </select>
            }
            else
            {
                <select class="form-control" style="width: 220px;" @bind="selectedProjectId" @bind:after="OnSelectionChanged">
                    <option value="0">Select a project...</option>
                    @foreach (var project in projects)
                    {
                        <option value="@project.Id">@project.Name</option>
                    }
                </select>
            }
        </div>
        <div class="action-bar-right">
            <div class="month-nav">
                <button class="month-nav-btn" @onclick="PreviousMonth" title="Previous month">&lt;</button>
                <span class="month-nav-label">@currentMonth.ToString("MMMM yyyy")</span>
                <button class="month-nav-btn" @onclick="NextMonth" title="Next month">&gt;</button>
            </div>
            <button class="btn btn-secondary btn-sm" @onclick="GoToToday">Today</button>
        </div>
    </div>

    <div class="calendar-container">
        <div class="calendar-header">
            @foreach (var day in new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" })
            {
                <div class="calendar-day-header">@day</div>
            }
        </div>

        <div class="calendar-grid">
            @foreach (var week in calendarWeeks)
            {
                <div class="calendar-week">
                    @foreach (var day in week)
                    {
                        var dayUnavailabilities = GetUnavailabilitiesForDay(day);
                        var hasFullDayUnavailability = dayUnavailabilities.Any(u => u.Hours >= 8);
                        var dayAllocations = hasFullDayUnavailability ? new List<AllocationDisplay>() : GetAllocationsForDay(day);
                        var isToday = day.Date == DateTime.Today;
                        var isCurrentMonth = day.Month == currentMonth.Month;

                        <div class="calendar-day @(!isCurrentMonth ? "other-month" : "") @(isToday ? "today" : "")">
                            <div class="calendar-day-number">@day.Day</div>
                            <div class="calendar-day-content">
                                @foreach (var unav in dayUnavailabilities)
                                {
                                    var startsToday = unav.StartDate.Date == day.Date;
                                    var endsToday = unav.EndDate.Date == day.Date;
                                    var isPartialDay = unav.Hours < 8;

                                    <div class="calendar-unavailability unavailability-@unav.Reason.ToString().ToLower() @(startsToday ? "starts-here" : "") @(endsToday ? "ends-here" : "") @(isPartialDay ? "partial-day" : "")"
                                         title="@unav.TooltipText">
                                        <span class="unavailability-icon">âœ•</span>
                                        <span class="unavailability-label">@unav.Label</span>
                                        @if (isPartialDay)
                                        {
                                            <span class="unavailability-hours-badge">@unav.Hours h</span>
                                        }
                                    </div>
                                }
                                @foreach (var alloc in dayAllocations)
                                {
                                    var startsToday = alloc.StartDate.Date == day.Date;
                                    var endsToday = alloc.EndDate.Date == day.Date;

                                    <div class="calendar-allocation @(startsToday ? "starts-here" : "") @(endsToday ? "ends-here" : "")"
                                         style="background-color: @alloc.Color;"
                                         title="@alloc.TooltipText">
                                        <span class="allocation-label">@alloc.Label</span>
                                        @if (alloc.Percentage.HasValue)
                                        {
                                            <span class="allocation-pct">@alloc.Percentage%</span>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>

    @if ((viewMode == "Resource" && selectedResourceId == 0) || (viewMode == "Project" && selectedProjectId == 0))
    {
        <div class="calendar-empty-state">
            <div class="empty-state-icon">ðŸ“…</div>
            <p>Select a @(viewMode.ToLower()) to view allocations</p>
        </div>
    }
    else if (!filteredAllocations.Any())
    {
        <div class="calendar-empty-state">
            <div class="empty-state-icon">ðŸ“­</div>
            <p>No allocations found for @currentMonth.ToString("MMMM yyyy")</p>
        </div>
    }
</div>

@if (viewMode == "Project" && selectedProjectId > 0 && filteredAllocations.Any())
{
    <div class="glass-card calendar-legend-card">
        <div class="glass-card-header">
            <h3 class="glass-card-title">Legend - Resources</h3>
        </div>
        <div class="calendar-legend">
            @foreach (var alloc in filteredAllocations.DistinctBy(a => a.ResourceId))
            {
                <div class="legend-item">
                    <span class="legend-color" style="background-color: @GetResourceColor(alloc.ResourceId);"></span>
                    <span class="legend-label">@alloc.Resource.Name</span>
                    <span class="legend-role">@alloc.Resource.Role.Name</span>
                </div>
            }
        </div>
    </div>
}

@if (viewMode == "Resource" && selectedResourceId > 0 && (filteredAllocations.Any() || filteredUnavailabilities.Any()))
{
    <div class="glass-card calendar-legend-card">
        <div class="glass-card-header">
            <h3 class="glass-card-title">Legend</h3>
        </div>
        <div class="calendar-legend">
            @if (filteredUnavailabilities.Any())
            {
                <div class="legend-section">
                    <span class="legend-section-title">Unavailability</span>
                    <div class="legend-item">
                        <span class="legend-color unavailability-pto"></span>
                        <span class="legend-label">PTO</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color unavailability-holiday"></span>
                        <span class="legend-label">Holiday</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color unavailability-sick"></span>
                        <span class="legend-label">Sick Leave</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color unavailability-other"></span>
                        <span class="legend-label">Other</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color partial-day-indicator"></span>
                        <span class="legend-label">Partial Day (striped)</span>
                    </div>
                </div>
            }
            @if (filteredAllocations.Any())
            {
                <div class="legend-section legend-section-projects">
                    <span class="legend-section-title">Projects</span>
                    @foreach (var alloc in filteredAllocations.DistinctBy(a => a.ProjectId))
                    {
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: @GetProjectColor(alloc.ProjectId);"></span>
                            <span class="legend-label">@alloc.Project.Name</span>
                            @if (alloc.Percentage.HasValue)
                            {
                                <span class="legend-pct">@alloc.Percentage%</span>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}

@code {
    private List<Resource> resources = new();
    private List<Project> projects = new();
    private List<Allocation> allocations = new();
    private List<Allocation> filteredAllocations = new();
    private List<ResourceUnavailability> unavailabilities = new();
    private List<ResourceUnavailability> filteredUnavailabilities = new();

    private string viewMode = "Resource";
    private int selectedResourceId = 0;
    private int selectedProjectId = 0;
    private DateTime currentMonth = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);

    private List<List<DateTime>> calendarWeeks = new();

    // Pastel color palette for visual distinction
    private static readonly string[] ColorPalette = new[]
    {
        "#a78bfa", "#93c5fd", "#86efac", "#fcd34d", "#fca5a5",
        "#c4b5fd", "#67e8f9", "#f9a8d4", "#5eead4", "#fdba74",
        "#a5b4fc", "#bef264", "#7dd3fc", "#d8b4fe", "#6ee7b7"
    };

    protected override async Task OnInitializedAsync()
    {
        resources = await DbContext.Resources
            .Include(r => r.Role)
            .OrderBy(r => r.Name)
            .ToListAsync();

        projects = await DbContext.Projects
            .OrderBy(p => p.Name)
            .ToListAsync();

        allocations = await DbContext.Allocations
            .Include(a => a.Resource).ThenInclude(r => r.Role)
            .Include(a => a.Project)
            .ToListAsync();

        unavailabilities = await DbContext.ResourceUnavailabilities
            .Include(u => u.Resource)
            .ToListAsync();

        BuildCalendarGrid();
        FilterAllocations();
        FilterUnavailabilities();
    }

    private void BuildCalendarGrid()
    {
        calendarWeeks.Clear();

        var firstDayOfMonth = new DateTime(currentMonth.Year, currentMonth.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);

        // Find the first Sunday on or before the first day of the month
        var startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);

        // Find the last Saturday on or after the last day of the month
        var endDate = lastDayOfMonth.AddDays(6 - (int)lastDayOfMonth.DayOfWeek);

        var currentDate = startDate;
        while (currentDate <= endDate)
        {
            var week = new List<DateTime>();
            for (int i = 0; i < 7; i++)
            {
                week.Add(currentDate);
                currentDate = currentDate.AddDays(1);
            }
            calendarWeeks.Add(week);
        }
    }

    private void FilterAllocations()
    {
        var firstDay = calendarWeeks.FirstOrDefault()?.FirstOrDefault() ?? currentMonth;
        var lastDay = calendarWeeks.LastOrDefault()?.LastOrDefault() ?? currentMonth.AddMonths(1);

        if (viewMode == "Resource" && selectedResourceId > 0)
        {
            filteredAllocations = allocations
                .Where(a => a.ResourceId == selectedResourceId &&
                           a.StartDate <= lastDay &&
                           a.EndDate >= firstDay)
                .OrderBy(a => a.StartDate)
                .ToList();
        }
        else if (viewMode == "Project" && selectedProjectId > 0)
        {
            filteredAllocations = allocations
                .Where(a => a.ProjectId == selectedProjectId &&
                           a.StartDate <= lastDay &&
                           a.EndDate >= firstDay)
                .OrderBy(a => a.Resource.Role.Name)
                .ThenBy(a => a.Resource.Name)
                .ToList();
        }
        else
        {
            filteredAllocations = new List<Allocation>();
        }
    }

    private void FilterUnavailabilities()
    {
        // Only show unavailabilities in Resource view mode
        if (viewMode != "Resource" || selectedResourceId <= 0)
        {
            filteredUnavailabilities = new List<ResourceUnavailability>();
            return;
        }

        var firstDay = calendarWeeks.FirstOrDefault()?.FirstOrDefault() ?? currentMonth;
        var lastDay = calendarWeeks.LastOrDefault()?.LastOrDefault() ?? currentMonth.AddMonths(1);

        filteredUnavailabilities = unavailabilities
            .Where(u => u.ResourceId == selectedResourceId &&
                       u.StartDate <= lastDay &&
                       u.EndDate >= firstDay)
            .OrderBy(u => u.StartDate)
            .ToList();
    }

    private List<UnavailabilityDisplay> GetUnavailabilitiesForDay(DateTime day)
    {
        return filteredUnavailabilities
            .Where(u => u.StartDate <= day && u.EndDate >= day)
            .Select(u => new UnavailabilityDisplay
            {
                UnavailabilityId = u.Id,
                Label = GetReasonDisplayName(u.Reason),
                Reason = u.Reason,
                Hours = u.Hours,
                StartDate = u.StartDate,
                EndDate = u.EndDate,
                TooltipText = BuildUnavailabilityTooltip(u)
            })
            .ToList();
    }

    private List<AllocationDisplay> GetAllocationsForDay(DateTime day)
    {
        return filteredAllocations
            .Where(a => a.StartDate <= day && a.EndDate >= day)
            .Select(a => new AllocationDisplay
            {
                AllocationId = a.Id,
                Label = viewMode == "Resource" ? a.Project.Name : a.Resource.Name,
                Percentage = a.Percentage,
                Color = viewMode == "Resource" ? GetProjectColor(a.ProjectId) : GetResourceColor(a.ResourceId),
                StartDate = a.StartDate,
                EndDate = a.EndDate,
                TooltipText = BuildTooltip(a)
            })
            .ToList();
    }

    private string BuildTooltip(Allocation a)
    {
        var text = viewMode == "Resource"
            ? $"{a.Project.Name}"
            : $"{a.Resource.Name} ({a.Resource.Role.Name})";

        if (a.Percentage.HasValue)
            text += $" - {a.Percentage}%";

        text += $"\n{a.StartDate:MMM dd} - {a.EndDate:MMM dd, yyyy}";

        return text;
    }

    private string BuildUnavailabilityTooltip(ResourceUnavailability u)
    {
        var text = GetReasonDisplayName(u.Reason);
        if (u.Hours < 8)
            text += $" ({u.Hours}h/day)";
        else
            text += " (Full day)";

        text += $"\n{u.StartDate:MMM dd} - {u.EndDate:MMM dd, yyyy}";

        if (!string.IsNullOrWhiteSpace(u.Notes))
            text += $"\n{u.Notes}";

        return text;
    }

    private string GetReasonDisplayName(UnavailabilityReason reason) => reason switch
    {
        UnavailabilityReason.PTO => "PTO",
        UnavailabilityReason.Holiday => "Holiday",
        UnavailabilityReason.SickLeave => "Sick Leave",
        UnavailabilityReason.Other => "Other",
        _ => reason.ToString()
    };

    private string GetUnavailabilityStyle(UnavailabilityReason reason, bool isPartialDay)
    {
        var baseColor = reason switch
        {
            UnavailabilityReason.PTO => "#fecaca",
            UnavailabilityReason.Holiday => "#d9f99d",
            UnavailabilityReason.SickLeave => "#fed7aa",
            UnavailabilityReason.Other => "#e5e7eb",
            _ => "#e5e7eb"
        };

        var borderColor = reason switch
        {
            UnavailabilityReason.PTO => "#f87171",
            UnavailabilityReason.Holiday => "#a3e635",
            UnavailabilityReason.SickLeave => "#fb923c",
            UnavailabilityReason.Other => "#9ca3af",
            _ => "#9ca3af"
        };

        if (isPartialDay)
        {
            return $"background: repeating-linear-gradient(45deg, {baseColor}, {baseColor} 4px, white 4px, white 8px); border-color: {borderColor};";
        }

        return $"background-color: {baseColor}; border-color: {borderColor};";
    }

    private string GetProjectColor(int projectId) => ColorPalette[projectId % ColorPalette.Length];
    private string GetResourceColor(int resourceId) => ColorPalette[resourceId % ColorPalette.Length];

    private void SetViewMode(string mode)
    {
        viewMode = mode;
        FilterAllocations();
        FilterUnavailabilities();
    }

    private void OnSelectionChanged()
    {
        FilterAllocations();
        FilterUnavailabilities();
    }

    private void PreviousMonth()
    {
        currentMonth = currentMonth.AddMonths(-1);
        BuildCalendarGrid();
        FilterAllocations();
        FilterUnavailabilities();
    }

    private void NextMonth()
    {
        currentMonth = currentMonth.AddMonths(1);
        BuildCalendarGrid();
        FilterAllocations();
        FilterUnavailabilities();
    }

    private void GoToToday()
    {
        currentMonth = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);
        BuildCalendarGrid();
        FilterAllocations();
        FilterUnavailabilities();
    }

    private class AllocationDisplay
    {
        public int AllocationId { get; set; }
        public string Label { get; set; } = "";
        public int? Percentage { get; set; }
        public string Color { get; set; } = "";
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public string TooltipText { get; set; } = "";
    }

    private class UnavailabilityDisplay
    {
        public int UnavailabilityId { get; set; }
        public string Label { get; set; } = "";
        public UnavailabilityReason Reason { get; set; }
        public int Hours { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public string TooltipText { get; set; } = "";
    }
}
