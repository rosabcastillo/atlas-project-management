@page "/calendar"
@using Microsoft.EntityFrameworkCore
@using ProjectManagement.Infrastructure.Data
@using ProjectManagement.Domain.Entities
@using ProjectManagement.Domain.Enums
@inject AppDbContext DbContext
@rendermode InteractiveServer

<PageTitle>Calendar - Nova</PageTitle>

<div class="page-header">
    <div>
        <h1 class="page-title">Calendar</h1>
        <p class="page-subtitle">Monthly view of resource and project allocations</p>
    </div>
</div>

<div class="glass-card">
    @if (showProjectDropdown)
    {
        <div class="multi-select-overlay" @onclick="CloseProjectDropdown"></div>
    }
    <div class="action-bar">
        <div class="action-bar-left">
            <div class="view-toggle">
                <button class="view-toggle-btn @(viewMode == "Resource" ? "active" : "")" @onclick='() => SetViewMode("Resource")'>
                    By Resource
                </button>
                <button class="view-toggle-btn @(viewMode == "Project" ? "active" : "")" @onclick='() => SetViewMode("Project")'>
                    By Project
                </button>
                <button class="view-toggle-btn @(viewMode == "Timeline" ? "active" : "")" @onclick='() => SetViewMode("Timeline")'>
                    Timeline
                </button>
            </div>

            @if (viewMode == "Resource")
            {
                <select class="btn btn-secondary btn-sm calendar-filter-select" @bind="selectedResourceId" @bind:after="OnSelectionChanged">
                    <option value="0">Select a resource...</option>
                    @foreach (var resource in resources)
                    {
                        <option value="@resource.Id">@resource.Name (@string.Join(", ", resource.ResourceRoles.Select(rr => rr.Role.Name)))</option>
                    }
                </select>
            }
            else if (viewMode == "Project")
            {
                <select class="btn btn-secondary btn-sm calendar-filter-select" @bind="selectedProjectId" @bind:after="OnSelectionChanged">
                    <option value="0">Select a project...</option>
                    @foreach (var project in projects)
                    {
                        <option value="@project.Id">@project.Name</option>
                    }
                </select>
            }
            else if (viewMode == "Timeline")
            {
                <div class="period-toggle">
                    <button class="period-toggle-btn @(timelinePeriod == "Month" ? "active" : "")" @onclick='() => SetTimelinePeriod("Month")'>Month</button>
                    <button class="period-toggle-btn @(timelinePeriod == "Quarter" ? "active" : "")" @onclick='() => SetTimelinePeriod("Quarter")'>Quarter</button>
                </div>

                <div class="multi-select-dropdown">
                    <button class="btn btn-secondary btn-sm multi-select-btn" @onclick="ToggleProjectDropdown" @onclick:stopPropagation="true">
                        @if (selectedProjectIds.Count == 0)
                        {
                            <span>Select projects...</span>
                        }
                        else
                        {
                            <span>@selectedProjectIds.Count project@(selectedProjectIds.Count != 1 ? "s" : "")</span>
                        }
                        <span class="dropdown-arrow">@(showProjectDropdown ? "\u25B2" : "\u25BC")</span>
                    </button>
                    @if (showProjectDropdown)
                    {
                        <div class="multi-select-menu" @onclick:stopPropagation="true">
                            <div class="multi-select-item" @onclick="SelectAllProjects">
                                <input type="checkbox" checked="@(selectedProjectIds.Count == projects.Count)" readonly />
                                <span style="font-weight: 600;">Select All</span>
                            </div>
                            @foreach (var project in projects)
                            {
                                var pId = project.Id;
                                <div class="multi-select-item" @onclick="() => ToggleProjectSelection(pId)">
                                    <input type="checkbox" checked="@selectedProjectIds.Contains(pId)" readonly />
                                    <span>@project.Name</span>
                                </div>
                            }
                        </div>
                    }
                </div>
            }
        </div>
        <div class="action-bar-right">
            <div class="month-nav">
                <button class="month-nav-btn" @onclick="PreviousMonth" title="@(viewMode == "Timeline" && timelinePeriod == "Quarter" ? "Previous quarter" : "Previous month")">&lt;</button>
                <span class="month-nav-label">
                    @if (viewMode == "Timeline" && timelinePeriod == "Quarter")
                    {
                        var qStart = GetQuarterStart(currentMonth);
                        var qEnd = GetQuarterEnd(currentMonth);
                        @($"{qStart:MMM} - {qEnd:MMM yyyy}")
                    }
                    else
                    {
                        @currentMonth.ToString("MMMM yyyy")
                    }
                </span>
                <button class="month-nav-btn" @onclick="NextMonth" title="@(viewMode == "Timeline" && timelinePeriod == "Quarter" ? "Next quarter" : "Next month")">&gt;</button>
            </div>
            @if (viewMode == "Timeline" && timelineProjects.Any(t => t.Resources.Any()))
            {
                <button class="btn btn-secondary btn-sm" style="white-space: nowrap;" @onclick="ToggleExpandAllTimeline" aria-label="@(allTimelineExpanded ? "Collapse All" : "Expand All")">
                    @(allTimelineExpanded ? "▲ Collapse All" : "▼ Expand All")
                </button>
            }
        </div>
    </div>

    @if (viewMode == "Timeline")
    {
        @if (selectedProjectIds.Count == 0)
        {
            <div class="calendar-empty-state">
                <div class="empty-state-icon"><i class="icon-chart-no-axes-column"></i></div>
                <p>Select one or more projects to view the timeline</p>
            </div>
        }
        else
        {
            var tStart = GetTimelineStart();
            var tEnd = GetTimelineEnd();
            var totalDays = (tEnd - tStart).Days + 1;
            var months = GetTimelineMonths(tStart, tEnd);
            var weeks = GetTimelineWeeks(tStart, tEnd);
            var todayPct = GetTodayPosition(tStart, tEnd, totalDays);

            <div class="timeline-legend-strip">
                <span class="timeline-legend-item">
                    <span class="timeline-legend-diamond pilot">&#x25C6;</span>
                    <span>Pilot Go-Live</span>
                </span>
                <span class="timeline-legend-item">
                    <span class="timeline-legend-diamond enterprise">&#x25C6;</span>
                    <span>Enterprise Go-Live</span>
                </span>
                <span class="timeline-legend-item">
                    <span class="timeline-legend-line"></span>
                    <span>Today</span>
                </span>
                <span class="timeline-legend-item">
                    <span class="timeline-legend-unavail"></span>
                    <span>Unavailable</span>
                </span>
                <span class="timeline-legend-item">
                    <span class="timeline-legend-unavail partial"></span>
                    <span>Partial Day</span>
                </span>
            </div>

            <div class="timeline-container">
                @* Header *@
                <div class="timeline-header">
                    @* Month row *@
                    <div class="timeline-header-row">
                        <div class="timeline-label-header">Project</div>
                        <div class="timeline-dates">
                            @foreach (var m in months)
                            {
                                <div class="timeline-month-cell" style="flex: @m.Days;">
                                    @m.Label
                                </div>
                            }
                        </div>
                    </div>
                    @* Week row *@
                    <div class="timeline-header-row">
                        <div class="timeline-label-header" style="font-size: 0.65rem; color: var(--text-muted);">Resource</div>
                        <div class="timeline-dates">
                            @foreach (var w in weeks)
                            {
                                <div class="timeline-week-cell" style="flex: @w.Days;">
                                    @w.Label
                                </div>
                            }
                        </div>
                    </div>
                </div>

                @* Body *@
                <div class="timeline-body">
                    @foreach (var tp in timelineProjects)
                    {
                        var isExpanded = expandedTimelineProjects.Contains(tp.ProjectId);

                        @* Project row *@
                        <div class="timeline-row project-row">
                            <div class="timeline-label">
                                @if (tp.Resources.Any())
                                {
                                    <button class="timeline-expand-btn" @onclick="() => ToggleTimelineExpand(tp.ProjectId)" title="@(isExpanded ? "Collapse" : "Expand")">
                                        @(isExpanded ? "\u25BC" : "\u25B6")
                                    </button>
                                }
                                <span class="timeline-label-name" title="@BuildProjectLabelTooltip(tp)">@tp.ProjectName</span>
                                @if (tp.HealthName != null)
                                {
                                    <span class="badge badge-sm timeline-health" style="background-color: @tp.HealthColor;">@tp.HealthShort</span>
                                }
                            </div>
                            <div class="timeline-bar-area">
                                @* Grid lines *@
                                @foreach (var w in weeks)
                                {
                                    var linePct = (double)(w.StartDate - tStart).Days / totalDays * 100;
                                    <div class="timeline-grid-line" style="left: @($"{linePct:F2}")%;"></div>
                                }

                                @* Project bar *@
                                @if (tp.BarLeftPct >= 0 && tp.BarWidthPct > 0)
                                {
                                    <div class="timeline-bar"
                                         style="left: @($"{tp.BarLeftPct:F2}")%; width: @($"{tp.BarWidthPct:F2}")%; background-color: @tp.Color;"
                                         title="@tp.ProjectName: @tp.EarliestStart.ToString("MMM dd") - @tp.LatestEnd.ToString("MMM dd, yyyy")">
                                        @tp.ProjectName
                                    </div>
                                }

                                @* Go-Live milestones *@
                                @if (tp.PilotGoLivePct.HasValue)
                                {
                                    <div class="timeline-milestone pilot"
                                         style="left: @($"{tp.PilotGoLivePct.Value:F2}")%;"
                                         title="Pilot Go-Live: @tp.PilotGoLiveDate!.Value.ToString("MMM dd, yyyy")">
                                        <span class="milestone-diamond">&#x25C6;</span>
                                        <span class="milestone-label">P</span>
                                    </div>
                                }
                                @if (tp.EnterpriseGoLivePct.HasValue)
                                {
                                    <div class="timeline-milestone enterprise"
                                         style="left: @($"{tp.EnterpriseGoLivePct.Value:F2}")%;"
                                         title="Enterprise Go-Live: @tp.EnterpriseGoLiveDate!.Value.ToString("MMM dd, yyyy")">
                                        <span class="milestone-diamond">&#x25C6;</span>
                                        <span class="milestone-label">E</span>
                                    </div>
                                }

                                @* Today line *@
                                @if (todayPct.HasValue)
                                {
                                    <div class="timeline-today-line" style="left: @($"{todayPct.Value:F2}")%;"></div>
                                }
                            </div>
                        </div>

                        @* Resource sub-rows *@
                        @if (isExpanded)
                        {
                            @foreach (var tr in tp.Resources)
                            {
                                <div class="timeline-row resource-row">
                                    <div class="timeline-label">
                                        <span class="timeline-label-name" title="@tr.ResourceName">@tr.ResourceName</span>
                                        @if (tr.Percentage.HasValue)
                                        {
                                            <span class="timeline-label-pct">@tr.Percentage%</span>
                                        }
                                    </div>
                                    <div class="timeline-bar-area">
                                        @* Grid lines *@
                                        @foreach (var w in weeks)
                                        {
                                            var linePct = (double)(w.StartDate - tStart).Days / totalDays * 100;
                                            <div class="timeline-grid-line" style="left: @($"{linePct:F2}")%;"></div>
                                        }

                                        @if (tr.BarLeftPct >= 0 && tr.BarWidthPct > 0)
                                        {
                                            <div class="timeline-resource-bar"
                                                 style="left: @($"{tr.BarLeftPct:F2}")%; width: @($"{tr.BarWidthPct:F2}")%; background-color: @tr.Color;"
                                                 title="@tr.ResourceName @(tr.Percentage.HasValue ? $"({tr.Percentage}%)" : ""): @tr.StartDate.ToString("MMM dd") - @tr.EndDate.ToString("MMM dd, yyyy")">
                                                @tr.ResourceName @(tr.Percentage.HasValue ? $"({tr.Percentage}%)" : "")
                                            </div>
                                        }

                                        @* Unavailability overlays *@
                                        @foreach (var u in tr.Unavailabilities)
                                        {
                                            <div class="timeline-unavailability-bar @(u.Hours < 8 ? "partial" : "")"
                                                 style="left: @($"{u.BarLeftPct:F2}")%; width: @($"{u.BarWidthPct:F2}")%;"
                                                 title="@u.TooltipText">
                                            </div>
                                        }

                                        @if (todayPct.HasValue)
                                        {
                                            <div class="timeline-today-line" style="left: @($"{todayPct.Value:F2}")%;"></div>
                                        }
                                    </div>
                                </div>
                            }
                        }
                    }

                    @if (!timelineProjects.Any())
                    {
                        <div class="timeline-empty">
                            No allocations found for the selected projects in this period.
                        </div>
                    }
                </div>
            </div>
        }
    }
    else
    {
        <div class="calendar-container">
            <div class="calendar-header">
                @foreach (var day in new[] { "Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat" })
                {
                    <div class="calendar-day-header">@day</div>
                }
            </div>

            <div class="calendar-grid">
                @foreach (var week in calendarWeeks)
                {
                    <div class="calendar-week">
                        @foreach (var day in week)
                        {
                            var dayUnavailabilities = GetUnavailabilitiesForDay(day);
                            var hasFullDayUnavailability = dayUnavailabilities.Any(u => u.Hours >= 8);
                            var dayAllocations = hasFullDayUnavailability ? new List<AllocationDisplay>() : GetAllocationsForDay(day);
                            var isToday = day.Date == DateTime.Today;
                            var isCurrentMonth = day.Month == currentMonth.Month;

                            <div class="calendar-day @(!isCurrentMonth ? "other-month" : "") @(isToday ? "today" : "")">
                                <div class="calendar-day-number">@day.Day</div>
                                <div class="calendar-day-content">
                                    @foreach (var unav in dayUnavailabilities)
                                    {
                                        var startsToday = unav.StartDate.Date == day.Date;
                                        var endsToday = unav.EndDate.Date == day.Date;
                                        var isPartialDay = unav.Hours < 8;

                                        <div class="calendar-unavailability unavailability-@unav.Reason.ToString().ToLower() @(startsToday ? "starts-here" : "") @(endsToday ? "ends-here" : "") @(isPartialDay ? "partial-day" : "")"
                                             title="@unav.TooltipText">
                                            <span class="unavailability-icon">&#x2715;</span>
                                            <span class="unavailability-label">@unav.Label</span>
                                            @if (isPartialDay)
                                            {
                                                <span class="unavailability-hours-badge">@unav.Hours h</span>
                                            }
                                        </div>
                                    }
                                    @foreach (var alloc in dayAllocations)
                                    {
                                        var startsToday = alloc.StartDate.Date == day.Date;
                                        var endsToday = alloc.EndDate.Date == day.Date;

                                        <div class="calendar-allocation @(startsToday ? "starts-here" : "") @(endsToday ? "ends-here" : "")"
                                             style="background-color: @alloc.Color;"
                                             title="@alloc.TooltipText">
                                            <span class="allocation-label">@alloc.Label</span>
                                            @if (alloc.Percentage.HasValue)
                                            {
                                                <span class="allocation-pct">@alloc.Percentage%</span>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        </div>

        @if ((viewMode == "Resource" && selectedResourceId == 0) || (viewMode == "Project" && selectedProjectId == 0))
        {
            <div class="calendar-empty-state">
                <div class="empty-state-icon"><i class="icon-calendar"></i></div>
                <p>Select a @(viewMode.ToLower()) to view allocations</p>
            </div>
        }
        else if (!filteredAllocations.Any())
        {
            <div class="calendar-empty-state">
                <div class="empty-state-icon"><i class="icon-inbox"></i></div>
                <p>No allocations found for @currentMonth.ToString("MMMM yyyy")</p>
            </div>
        }
    }
</div>

@if (viewMode == "Project" && selectedProjectId > 0 && filteredAllocations.Any())
{
    <div class="glass-card calendar-legend-card">
        <div class="glass-card-header">
            <h3 class="glass-card-title">Legend - Resources</h3>
        </div>
        <div class="calendar-legend">
            @foreach (var alloc in filteredAllocations.DistinctBy(a => a.ResourceId))
            {
                <div class="legend-item">
                    <span class="legend-color" style="background-color: @GetResourceColor(alloc.ResourceId);"></span>
                    <span class="legend-label">@alloc.Resource.Name</span>
                    <span class="legend-role">@string.Join(", ", alloc.Resource.ResourceRoles.Select(rr => rr.Role.Name))</span>
                </div>
            }
        </div>
    </div>
}

@if (viewMode == "Resource" && selectedResourceId > 0 && (filteredAllocations.Any() || filteredUnavailabilities.Any() || filteredVendorHolidays.Any()))
{
    <div class="glass-card calendar-legend-card">
        <div class="glass-card-header">
            <h3 class="glass-card-title">Legend</h3>
        </div>
        <div class="calendar-legend">
            @if (filteredUnavailabilities.Any() || filteredVendorHolidays.Any())
            {
                <div class="legend-section">
                    <span class="legend-section-title">Unavailability</span>
                    <div class="legend-item">
                        <span class="legend-color unavailability-pto"></span>
                        <span class="legend-label">PTO</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color unavailability-holiday"></span>
                        <span class="legend-label">Holiday</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color unavailability-sick"></span>
                        <span class="legend-label">Sick Leave</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color unavailability-other"></span>
                        <span class="legend-label">Other</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-color partial-day-indicator"></span>
                        <span class="legend-label">Partial Day (striped)</span>
                    </div>
                </div>
            }
            @if (filteredAllocations.Any())
            {
                <div class="legend-section legend-section-projects">
                    <span class="legend-section-title">Projects</span>
                    @foreach (var alloc in filteredAllocations.DistinctBy(a => a.ProjectId))
                    {
                        <div class="legend-item">
                            <span class="legend-color" style="background-color: @GetProjectColor(alloc.ProjectId);"></span>
                            <span class="legend-label">@alloc.Project.Name</span>
                            @if (alloc.Percentage.HasValue)
                            {
                                <span class="legend-pct">@alloc.Percentage%</span>
                            }
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}

@code {
    private List<Resource> resources = new();
    private List<Project> projects = new();
    private List<Allocation> allocations = new();
    private List<Allocation> filteredAllocations = new();
    private List<ResourceUnavailability> unavailabilities = new();
    private List<ResourceUnavailability> filteredUnavailabilities = new();
    private List<VendorHoliday> vendorHolidays = new();
    private List<VendorHoliday> filteredVendorHolidays = new();

    private string viewMode = "Resource";
    private int selectedResourceId = 0;
    private int selectedProjectId = 0;
    private DateTime currentMonth = new DateTime(DateTime.Today.Year, DateTime.Today.Month, 1);

    private List<List<DateTime>> calendarWeeks = new();

    // Timeline state
    private string timelinePeriod = "Month";
    private HashSet<int> selectedProjectIds = new();
    private HashSet<int> expandedTimelineProjects = new();
    private bool allTimelineExpanded = false;
    private bool showProjectDropdown = false;
    private List<TimelineProject> timelineProjects = new();

    // Project colors — warm tones (purples, pinks, oranges, yellows)
    private static readonly string[] ProjectPalette = new[]
    {
        "#a78bfa", "#f9a8d4", "#fcd34d", "#fca5a5", "#c4b5fd",
        "#fdba74", "#d8b4fe", "#fbbf24", "#f0abfc", "#fb923c",
        "#e9d5ff", "#fda4af", "#fde68a", "#c084fc", "#fed7aa"
    };

    // Resource colors — cool tones (blues, greens, teals, cyans)
    private static readonly string[] ResourcePalette = new[]
    {
        "#93c5fd", "#86efac", "#67e8f9", "#5eead4", "#a5b4fc",
        "#bef264", "#7dd3fc", "#6ee7b7", "#a7f3d0", "#38bdf8",
        "#99f6e4", "#7dd3fc", "#4ade80", "#22d3ee", "#34d399"
    };

    protected override async Task OnInitializedAsync()
    {
        resources = await DbContext.Resources
            .Include(r => r.ResourceRoles).ThenInclude(rr => rr.Role)
            .Include(r => r.Vendor)
            .OrderBy(r => r.Name)
            .ToListAsync();

        projects = await DbContext.Projects
            .Include(p => p.Theme)
            .Include(p => p.Status)
            .Include(p => p.Health)
            .OrderBy(p => p.Name)
            .ToListAsync();

        allocations = await DbContext.Allocations
            .Include(a => a.Resource).ThenInclude(r => r.ResourceRoles).ThenInclude(rr => rr.Role)
            .Include(a => a.Resource).ThenInclude(r => r.Vendor)
            .Include(a => a.Project)
            .ToListAsync();

        unavailabilities = await DbContext.ResourceUnavailabilities
            .Include(u => u.Resource)
            .ToListAsync();

        vendorHolidays = await DbContext.VendorHolidays
            .Include(vh => vh.Vendor)
            .ToListAsync();

        BuildCalendarGrid();
        FilterAllocations();
        FilterUnavailabilities();
    }

    private void BuildCalendarGrid()
    {
        calendarWeeks.Clear();

        var firstDayOfMonth = new DateTime(currentMonth.Year, currentMonth.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);

        // Find the first Sunday on or before the first day of the month
        var startDate = firstDayOfMonth.AddDays(-(int)firstDayOfMonth.DayOfWeek);

        // Find the last Saturday on or after the last day of the month
        var endDate = lastDayOfMonth.AddDays(6 - (int)lastDayOfMonth.DayOfWeek);

        var currentDate = startDate;
        while (currentDate <= endDate)
        {
            var week = new List<DateTime>();
            for (int i = 0; i < 7; i++)
            {
                week.Add(currentDate);
                currentDate = currentDate.AddDays(1);
            }
            calendarWeeks.Add(week);
        }
    }

    private void FilterAllocations()
    {
        var firstDay = calendarWeeks.FirstOrDefault()?.FirstOrDefault() ?? currentMonth;
        var lastDay = calendarWeeks.LastOrDefault()?.LastOrDefault() ?? currentMonth.AddMonths(1);

        if (viewMode == "Resource" && selectedResourceId > 0)
        {
            filteredAllocations = allocations
                .Where(a => a.ResourceId == selectedResourceId &&
                           a.StartDate <= lastDay &&
                           a.EndDate >= firstDay)
                .OrderBy(a => a.StartDate)
                .ToList();
        }
        else if (viewMode == "Project" && selectedProjectId > 0)
        {
            filteredAllocations = allocations
                .Where(a => a.ProjectId == selectedProjectId &&
                           a.StartDate <= lastDay &&
                           a.EndDate >= firstDay)
                .OrderBy(a => a.Resource.ResourceRoles.FirstOrDefault()?.Role.Name ?? "")
                .ThenBy(a => a.Resource.Name)
                .ToList();
        }
        else
        {
            filteredAllocations = new List<Allocation>();
        }
    }

    private void FilterUnavailabilities()
    {
        // Only show unavailabilities in Resource view mode
        if (viewMode != "Resource" || selectedResourceId <= 0)
        {
            filteredUnavailabilities = new List<ResourceUnavailability>();
            filteredVendorHolidays = new List<VendorHoliday>();
            return;
        }

        var firstDay = calendarWeeks.FirstOrDefault()?.FirstOrDefault() ?? currentMonth;
        var lastDay = calendarWeeks.LastOrDefault()?.LastOrDefault() ?? currentMonth.AddMonths(1);

        filteredUnavailabilities = unavailabilities
            .Where(u => u.ResourceId == selectedResourceId &&
                       u.StartDate <= lastDay &&
                       u.EndDate >= firstDay)
            .OrderBy(u => u.StartDate)
            .ToList();

        // Filter vendor holidays for the selected resource's vendor
        var resource = resources.FirstOrDefault(r => r.Id == selectedResourceId);
        if (resource?.VendorId != null)
        {
            filteredVendorHolidays = vendorHolidays
                .Where(vh => vh.VendorId == resource.VendorId &&
                            vh.Date >= firstDay &&
                            vh.Date <= lastDay)
                .OrderBy(vh => vh.Date)
                .ToList();
        }
        else
        {
            filteredVendorHolidays = new List<VendorHoliday>();
        }
    }

    private List<UnavailabilityDisplay> GetUnavailabilitiesForDay(DateTime day)
    {
        var result = filteredUnavailabilities
            .Where(u => u.StartDate <= day && u.EndDate >= day)
            .Select(u => new UnavailabilityDisplay
            {
                UnavailabilityId = u.Id,
                Label = DisplayHelpers.GetReasonDisplayName(u.Reason),
                Reason = u.Reason,
                Hours = u.Hours,
                StartDate = u.StartDate,
                EndDate = u.EndDate,
                TooltipText = BuildUnavailabilityTooltip(u)
            })
            .ToList();

        // Add vendor holidays for this day
        var holidaysForDay = filteredVendorHolidays
            .Where(vh => vh.Date.Date == day.Date)
            .Select(vh => new UnavailabilityDisplay
            {
                UnavailabilityId = -vh.Id,
                Label = $"Holiday: {vh.Name}",
                Reason = UnavailabilityReason.Holiday,
                Hours = 8,
                StartDate = vh.Date,
                EndDate = vh.Date,
                TooltipText = $"Organization Holiday: {vh.Name}\n{vh.Date:MMM dd, yyyy}"
            });

        result.AddRange(holidaysForDay);
        return result;
    }

    private List<AllocationDisplay> GetAllocationsForDay(DateTime day)
    {
        return filteredAllocations
            .Where(a => a.StartDate <= day && a.EndDate >= day)
            .Select(a => new AllocationDisplay
            {
                AllocationId = a.Id,
                Label = viewMode == "Resource" ? a.Project.Name : a.Resource.Name,
                Percentage = a.Percentage,
                Color = viewMode == "Resource" ? GetProjectColor(a.ProjectId) : GetResourceColor(a.ResourceId),
                StartDate = a.StartDate,
                EndDate = a.EndDate,
                TooltipText = BuildTooltip(a)
            })
            .ToList();
    }

    private string BuildTooltip(Allocation a)
    {
        var text = viewMode == "Resource"
            ? $"{a.Project.Name}"
            : $"{a.Resource.Name} ({string.Join(", ", a.Resource.ResourceRoles.Select(rr => rr.Role.Name))})";

        if (a.Percentage.HasValue)
            text += $" - {a.Percentage}%";

        text += $"\n{a.StartDate:MMM dd} - {a.EndDate:MMM dd, yyyy}";

        return text;
    }

    private string BuildUnavailabilityTooltip(ResourceUnavailability u)
    {
        var text = DisplayHelpers.GetReasonDisplayName(u.Reason);
        if (u.Hours < 8)
            text += $" ({u.Hours}h/day)";
        else
            text += " (Full day)";

        text += $"\n{u.StartDate:MMM dd} - {u.EndDate:MMM dd, yyyy}";

        if (!string.IsNullOrWhiteSpace(u.Notes))
            text += $"\n{u.Notes}";

        return text;
    }

    private string GetProjectColor(int projectId) => ProjectPalette[projectId % ProjectPalette.Length];
    private string GetResourceColor(int resourceId) => ResourcePalette[resourceId % ResourcePalette.Length];

    private void SetViewMode(string mode)
    {
        viewMode = mode;
        if (mode == "Timeline")
        {
            BuildTimelineData();
        }
        else
        {
            FilterAllocations();
            FilterUnavailabilities();
        }
    }

    private void OnSelectionChanged()
    {
        FilterAllocations();
        FilterUnavailabilities();
    }

    private void PreviousMonth()
    {
        if (viewMode == "Timeline" && timelinePeriod == "Quarter")
        {
            currentMonth = currentMonth.AddMonths(-3);
        }
        else
        {
            currentMonth = currentMonth.AddMonths(-1);
        }
        BuildCalendarGrid();
        if (viewMode == "Timeline")
            BuildTimelineData();
        else
        {
            FilterAllocations();
            FilterUnavailabilities();
        }
    }

    private void NextMonth()
    {
        if (viewMode == "Timeline" && timelinePeriod == "Quarter")
        {
            currentMonth = currentMonth.AddMonths(3);
        }
        else
        {
            currentMonth = currentMonth.AddMonths(1);
        }
        BuildCalendarGrid();
        if (viewMode == "Timeline")
            BuildTimelineData();
        else
        {
            FilterAllocations();
            FilterUnavailabilities();
        }
    }

    // ===== Timeline Methods =====

    private void SetTimelinePeriod(string period)
    {
        timelinePeriod = period;
        BuildTimelineData();
    }

    private void ToggleProjectDropdown()
    {
        showProjectDropdown = !showProjectDropdown;
    }

    private void CloseProjectDropdown()
    {
        showProjectDropdown = false;
        BuildTimelineData();
    }

    private void ToggleProjectSelection(int projectId)
    {
        if (!selectedProjectIds.Remove(projectId))
            selectedProjectIds.Add(projectId);
        BuildTimelineData();
    }

    private void SelectAllProjects()
    {
        if (selectedProjectIds.Count == projects.Count)
            selectedProjectIds.Clear();
        else
            selectedProjectIds = projects.Select(p => p.Id).ToHashSet();
        BuildTimelineData();
    }

    private void ToggleTimelineExpand(int projectId)
    {
        if (!expandedTimelineProjects.Remove(projectId))
            expandedTimelineProjects.Add(projectId);
    }

    private void ToggleExpandAllTimeline()
    {
        if (allTimelineExpanded)
        {
            expandedTimelineProjects.Clear();
        }
        else
        {
            foreach (var tp in timelineProjects.Where(t => t.Resources.Any()))
            {
                expandedTimelineProjects.Add(tp.ProjectId);
            }
        }
        allTimelineExpanded = !allTimelineExpanded;
    }

    private DateTime GetTimelineStart()
    {
        if (timelinePeriod == "Quarter")
            return GetQuarterStart(currentMonth);
        return new DateTime(currentMonth.Year, currentMonth.Month, 1);
    }

    private DateTime GetTimelineEnd()
    {
        if (timelinePeriod == "Quarter")
            return GetQuarterEnd(currentMonth);
        return new DateTime(currentMonth.Year, currentMonth.Month, 1).AddMonths(1).AddDays(-1);
    }

    private DateTime GetQuarterStart(DateTime date)
    {
        var quarterMonth = ((date.Month - 1) / 3) * 3 + 1;
        return new DateTime(date.Year, quarterMonth, 1);
    }

    private DateTime GetQuarterEnd(DateTime date)
    {
        var quarterStart = GetQuarterStart(date);
        return quarterStart.AddMonths(3).AddDays(-1);
    }

    private void BuildTimelineData()
    {
        timelineProjects.Clear();
        if (selectedProjectIds.Count == 0) return;

        var tStart = GetTimelineStart();
        var tEnd = GetTimelineEnd();
        var totalDays = (tEnd - tStart).Days + 1;

        foreach (var projectId in selectedProjectIds.OrderBy(id => projects.FirstOrDefault(p => p.Id == id)?.Name))
        {
            var project = projects.FirstOrDefault(p => p.Id == projectId);
            if (project == null) continue;

            var projectAllocations = allocations
                .Where(a => a.ProjectId == projectId && a.StartDate <= tEnd && a.EndDate >= tStart)
                .OrderBy(a => a.Resource.Name)
                .ToList();

            var tp = new TimelineProject
            {
                ProjectId = projectId,
                ProjectName = project.Name,
                HealthName = project.Health?.Name,
                HealthColor = project.Health?.Color ?? "#6b7280",
                HealthShort = project.Health?.ShortName ?? GetHealthShortName(project.Health?.Name),
                Color = GetProjectColor(projectId),
                PilotGoLiveDate = project.TargetPilotGoLiveDate,
                EnterpriseGoLiveDate = project.TargetEnterpriseGoLiveDate
            };

            if (projectAllocations.Any())
            {
                tp.EarliestStart = projectAllocations.Min(a => a.StartDate);
                tp.LatestEnd = projectAllocations.Max(a => a.EndDate);

                var barStart = tp.EarliestStart < tStart ? tStart : tp.EarliestStart;
                var barEnd = tp.LatestEnd > tEnd ? tEnd : tp.LatestEnd;

                tp.BarLeftPct = (double)(barStart - tStart).Days / totalDays * 100;
                tp.BarWidthPct = (double)((barEnd - barStart).Days + 1) / totalDays * 100;
            }

            // Go-Live milestone positions
            if (project.TargetPilotGoLiveDate.HasValue)
            {
                var pilotDate = project.TargetPilotGoLiveDate.Value;
                if (pilotDate >= tStart && pilotDate <= tEnd)
                {
                    tp.PilotGoLivePct = (double)(pilotDate - tStart).Days / totalDays * 100;
                }
            }
            if (project.TargetEnterpriseGoLiveDate.HasValue)
            {
                var entDate = project.TargetEnterpriseGoLiveDate.Value;
                if (entDate >= tStart && entDate <= tEnd)
                {
                    tp.EnterpriseGoLivePct = (double)(entDate - tStart).Days / totalDays * 100;
                }
            }

            // Resource sub-rows
            foreach (var alloc in projectAllocations)
            {
                var rBarStart = alloc.StartDate < tStart ? tStart : alloc.StartDate;
                var rBarEnd = alloc.EndDate > tEnd ? tEnd : alloc.EndDate;

                var tr = new TimelineResource
                {
                    ResourceName = alloc.Resource.Name,
                    Percentage = alloc.Percentage,
                    Color = GetResourceColor(alloc.ResourceId),
                    StartDate = alloc.StartDate,
                    EndDate = alloc.EndDate,
                    BarLeftPct = (double)(rBarStart - tStart).Days / totalDays * 100,
                    BarWidthPct = (double)((rBarEnd - rBarStart).Days + 1) / totalDays * 100
                };

                // Add unavailabilities for this resource
                var resourceUnavs = unavailabilities
                    .Where(u => u.ResourceId == alloc.ResourceId && u.StartDate <= tEnd && u.EndDate >= tStart)
                    .ToList();

                foreach (var u in resourceUnavs)
                {
                    var uStart = u.StartDate < tStart ? tStart : u.StartDate;
                    var uEnd = u.EndDate > tEnd ? tEnd : u.EndDate;

                    tr.Unavailabilities.Add(new TimelineUnavailability
                    {
                        Reason = DisplayHelpers.GetReasonDisplayName(u.Reason),
                        Hours = u.Hours,
                        StartDate = u.StartDate,
                        EndDate = u.EndDate,
                        BarLeftPct = (double)(uStart - tStart).Days / totalDays * 100,
                        BarWidthPct = (double)((uEnd - uStart).Days + 1) / totalDays * 100,
                        TooltipText = $"{DisplayHelpers.GetReasonDisplayName(u.Reason)}{(u.Hours < 8 ? $" ({u.Hours}h/day)" : "")}: {u.StartDate:MMM dd} - {u.EndDate:MMM dd, yyyy}"
                    });
                }

                // Add vendor holidays for this resource
                var resourceObj = alloc.Resource;
                if (resourceObj.VendorId != null)
                {
                    var resourceVendorHolidays = vendorHolidays
                        .Where(vh => vh.VendorId == resourceObj.VendorId && vh.Date >= tStart && vh.Date <= tEnd)
                        .ToList();

                    foreach (var vh in resourceVendorHolidays)
                    {
                        tr.Unavailabilities.Add(new TimelineUnavailability
                        {
                            Reason = "Holiday",
                            Hours = 8,
                            StartDate = vh.Date,
                            EndDate = vh.Date,
                            BarLeftPct = (double)(vh.Date - tStart).Days / totalDays * 100,
                            BarWidthPct = (double)1 / totalDays * 100,
                            TooltipText = $"Organization Holiday: {vh.Name}\n{vh.Date:MMM dd, yyyy}"
                        });
                    }
                }

                tp.Resources.Add(tr);
            }

            timelineProjects.Add(tp);
        }
    }

    private List<TimelineMonth> GetTimelineMonths(DateTime tStart, DateTime tEnd)
    {
        var months = new List<TimelineMonth>();
        var current = new DateTime(tStart.Year, tStart.Month, 1);

        while (current <= tEnd)
        {
            var monthStart = current < tStart ? tStart : current;
            var monthEnd = current.AddMonths(1).AddDays(-1);
            if (monthEnd > tEnd) monthEnd = tEnd;

            months.Add(new TimelineMonth
            {
                Label = current.ToString("MMM yyyy"),
                Days = (monthEnd - monthStart).Days + 1,
                StartDate = monthStart
            });

            current = current.AddMonths(1);
        }

        return months;
    }

    private List<TimelineWeek> GetTimelineWeeks(DateTime tStart, DateTime tEnd)
    {
        var weeks = new List<TimelineWeek>();
        // Start from the Monday on or before tStart
        var current = tStart;

        while (current <= tEnd)
        {
            var weekEnd = current.AddDays(6);
            if (weekEnd > tEnd) weekEnd = tEnd;

            weeks.Add(new TimelineWeek
            {
                Label = current.ToString("MMM dd"),
                Days = (weekEnd - current).Days + 1,
                StartDate = current
            });

            current = weekEnd.AddDays(1);
        }

        return weeks;
    }

    private double? GetTodayPosition(DateTime tStart, DateTime tEnd, int totalDays)
    {
        var today = DateTime.Today;
        if (today >= tStart && today <= tEnd)
            return (double)(today - tStart).Days / totalDays * 100;
        return null;
    }

    private string BuildProjectLabelTooltip(TimelineProject tp)
    {
        var text = tp.ProjectName;
        if (tp.PilotGoLiveDate.HasValue)
            text += $"\nPilot Go-Live: {tp.PilotGoLiveDate.Value:MMM dd, yyyy}";
        if (tp.EnterpriseGoLiveDate.HasValue)
            text += $"\nEnterprise Go-Live: {tp.EnterpriseGoLiveDate.Value:MMM dd, yyyy}";
        if (tp.HealthName != null)
            text += $"\nHealth: {tp.HealthName}";
        return text;
    }

    private string GetHealthShortName(string? healthName)
    {
        if (healthName == null) return "";
        return healthName.Length > 4 ? healthName[..4] : healthName;
    }

    // ===== Display Classes =====

    private class AllocationDisplay
    {
        public int AllocationId { get; set; }
        public string Label { get; set; } = "";
        public int? Percentage { get; set; }
        public string Color { get; set; } = "";
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public string TooltipText { get; set; } = "";
    }

    private class UnavailabilityDisplay
    {
        public int UnavailabilityId { get; set; }
        public string Label { get; set; } = "";
        public UnavailabilityReason Reason { get; set; }
        public int Hours { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public string TooltipText { get; set; } = "";
    }

    private class TimelineProject
    {
        public int ProjectId { get; set; }
        public string ProjectName { get; set; } = "";
        public string? HealthName { get; set; }
        public string HealthColor { get; set; } = "#6b7280";
        public string HealthShort { get; set; } = "";
        public string Color { get; set; } = "";
        public DateTime EarliestStart { get; set; }
        public DateTime LatestEnd { get; set; }
        public double BarLeftPct { get; set; } = -1;
        public double BarWidthPct { get; set; }
        public DateTime? PilotGoLiveDate { get; set; }
        public DateTime? EnterpriseGoLiveDate { get; set; }
        public double? PilotGoLivePct { get; set; }
        public double? EnterpriseGoLivePct { get; set; }
        public List<TimelineResource> Resources { get; set; } = new();
    }

    private class TimelineResource
    {
        public string ResourceName { get; set; } = "";
        public int? Percentage { get; set; }
        public string Color { get; set; } = "";
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public double BarLeftPct { get; set; }
        public double BarWidthPct { get; set; }
        public List<TimelineUnavailability> Unavailabilities { get; set; } = new();
    }

    private class TimelineUnavailability
    {
        public string Reason { get; set; } = "";
        public int Hours { get; set; }
        public DateTime StartDate { get; set; }
        public DateTime EndDate { get; set; }
        public double BarLeftPct { get; set; }
        public double BarWidthPct { get; set; }
        public string TooltipText { get; set; } = "";
    }

    private class TimelineMonth
    {
        public string Label { get; set; } = "";
        public int Days { get; set; }
        public DateTime StartDate { get; set; }
    }

    private class TimelineWeek
    {
        public string Label { get; set; } = "";
        public int Days { get; set; }
        public DateTime StartDate { get; set; }
    }
}
