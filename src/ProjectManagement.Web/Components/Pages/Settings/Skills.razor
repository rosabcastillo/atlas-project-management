@page "/settings/skills"
@using Microsoft.EntityFrameworkCore
@using ProjectManagement.Infrastructure.Data
@using ProjectManagement.Domain.Entities
@inject AppDbContext DbContext
@rendermode InteractiveServer

<PageTitle>Skills - Settings</PageTitle>

<div class="page-header">
    <div>
        <h1 class="page-title">Skills</h1>
        <p class="page-subtitle">Manage technical skills and competencies</p>
    </div>
    <button class="btn btn-primary" @onclick="OpenAddModal">+ Add Skill</button>
</div>

<div class="glass-card">
    <div class="action-bar">
        <div class="action-bar-left">
            <div class="search-box">
                <input type="text" class="form-control" placeholder="Search skills..." @bind="searchTerm" @bind:event="oninput" />
            </div>
        </div>
    </div>

    <div class="skill-tags" style="gap: 0.75rem; padding: 1rem 0;">
        @foreach (var skill in FilteredSkills)
        {
            <div class="skill-tag skill-tag-lg">
                @skill.Name
                <span class="skill-tag-count">(@skill.ResourceSkills.Count)</span>
                <button class="skill-tag-action"
                        @onclick="() => OpenEditModal(skill)" title="Edit" aria-label="Edit skill @skill.Name">
                    ‚úèÔ∏è
                </button>
                @if (skill.ResourceSkills.Count == 0)
                {
                    <button class="skill-tag-action"
                            @onclick="() => ConfirmDelete(skill)" title="Delete" aria-label="Delete skill @skill.Name">
                        ‚ùå
                    </button>
                }
            </div>
        }
    </div>

    @if (!FilteredSkills.Any())
    {
        <div class="empty-state">
            <div class="empty-state-icon">üõ†Ô∏è</div>
            <p>No skills found. Add a new skill to get started.</p>
        </div>
    }
</div>

@if (showModal)
{
    <div class="modal-backdrop" @onclick="CloseModal">
        <div class="modal" @onclick:stopPropagation="true" role="dialog" aria-labelledby="modal-title-skill">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title-skill">@(isEditing ? "Edit Skill" : "Add Skill")</h3>
                <button class="modal-close" @onclick="CloseModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Skill Name *</label>
                    <input type="text" class="form-control" @bind="currentSkill.Name" />
                    @if (!string.IsNullOrEmpty(skillError))
                    {
                        <div class="text-danger field-validation-error">@skillError</div>
                    }
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                <button class="btn btn-primary" @onclick="SaveSkill">Save</button>
            </div>
        </div>
    </div>
}

<ConfirmDeleteModal Visible="showDeleteConfirm"
    Message="@($"Are you sure you want to delete skill \"{skillToDelete?.Name}\"?")"
    OnConfirm="DeleteSkill"
    OnCancel="CancelDelete" />

@code {
    private List<Skill> skills = new();
    private string searchTerm = "";
    private bool showModal = false;
    private bool isEditing = false;
    private Skill currentSkill = new();
    private string? skillError = null;
    private bool showDeleteConfirm = false;
    private Skill? skillToDelete = null;

    private IEnumerable<Skill> FilteredSkills => string.IsNullOrWhiteSpace(searchTerm)
        ? skills
        : skills.Where(s => s.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadSkills();
    }

    private async Task LoadSkills()
    {
        skills = await DbContext.Skills
            .Include(s => s.ResourceSkills)
            .OrderBy(s => s.Name)
            .ToListAsync();
    }

    private void OpenAddModal()
    {
        currentSkill = new Skill();
        isEditing = false;
        skillError = null;
        showModal = true;
    }

    private void OpenEditModal(Skill skill)
    {
        currentSkill = new Skill
        {
            Id = skill.Id,
            Name = skill.Name
        };
        isEditing = true;
        skillError = null;
        showModal = true;
    }

    private void CloseModal()
    {
        skillError = null;
        showModal = false;
    }

    private async Task SaveSkill()
    {
        skillError = null;
        if (string.IsNullOrWhiteSpace(currentSkill.Name))
            return;

        var nameToCheck = currentSkill.Name.Trim().ToLower();
        var duplicate = await DbContext.Skills
            .AnyAsync(s => s.Name.ToLower() == nameToCheck && (!isEditing || s.Id != currentSkill.Id));
        if (duplicate)
        {
            skillError = "A skill with this name already exists.";
            return;
        }

        if (isEditing)
        {
            var existing = await DbContext.Skills.FindAsync(currentSkill.Id);
            if (existing != null)
            {
                existing.Name = currentSkill.Name;
                await DbContext.SaveChangesAsync();
            }
        }
        else
        {
            DbContext.Skills.Add(currentSkill);
            await DbContext.SaveChangesAsync();
        }

        await LoadSkills();
        CloseModal();
    }

    private void ConfirmDelete(Skill skill)
    {
        skillToDelete = skill;
        showDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        skillToDelete = null;
        showDeleteConfirm = false;
    }

    private async Task DeleteSkill()
    {
        if (skillToDelete == null) return;
        DbContext.Skills.Remove(skillToDelete);
        await DbContext.SaveChangesAsync();
        skillToDelete = null;
        showDeleteConfirm = false;
        await LoadSkills();
    }
}
