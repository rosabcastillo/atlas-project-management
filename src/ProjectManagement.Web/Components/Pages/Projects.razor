@page "/projects"
@using Microsoft.EntityFrameworkCore
@using ProjectManagement.Infrastructure.Data
@using ProjectManagement.Domain.Entities
@using ProjectManagement.Domain.Enums
@inject AppDbContext DbContext
@rendermode InteractiveServer

<PageTitle>Projects - Nova</PageTitle>

<div class="page-header">
    <div>
        <h1 class="page-title">Projects</h1>
        <p class="page-subtitle">Manage your project portfolio</p>
    </div>
    <button class="btn btn-primary" @onclick="OpenAddModal">+ Add Project</button>
</div>

<div class="glass-card">
    @if (showStatusDropdown || showLeadDropdown)
    {
        <div class="multi-select-overlay" @onclick="CloseAllDropdowns"></div>
    }
    <div class="action-bar">
        <div class="action-bar-left">
            <div class="search-box">
                <input type="text" class="form-control" placeholder="Search projects..." @bind="searchTerm" @bind:event="oninput" />
            </div>
            <div class="multi-select-dropdown">
                <button type="button" class="form-control multi-select-btn" @onclick="ToggleStatusDropdown" @onclick:stopPropagation="true">
                    @GetStatusFilterLabel()
                    <span class="dropdown-arrow">▼</span>
                </button>
                @if (showStatusDropdown)
                {
                    <div class="multi-select-menu" @onclick:stopPropagation="true">
                        <label class="multi-select-item">
                            <input type="checkbox" checked="@(filterStatusIds.Count == 0)" @onclick="SelectAllStatuses" />
                            <span>All Statuses</span>
                        </label>
                        @foreach (var status in statuses)
                        {
                            var statusId = status.Id;
                            <label class="multi-select-item">
                                <input type="checkbox" checked="@filterStatusIds.Contains(statusId)" @onclick="() => ToggleStatusFilter(statusId)" />
                                <span class="status-badge" style="background-color: @status.Color; font-size: 0.7rem;">@status.Name</span>
                            </label>
                        }
                        <div class="multi-select-actions">
                            <button type="button" class="btn btn-sm btn-primary" @onclick="CloseStatusDropdown">Done</button>
                        </div>
                    </div>
                }
            </div>
            <div class="multi-select-dropdown">
                <button type="button" class="form-control multi-select-btn" @onclick="ToggleLeadDropdown" @onclick:stopPropagation="true">
                    @GetLeadFilterLabel()
                    <span class="dropdown-arrow">▼</span>
                </button>
                @if (showLeadDropdown)
                {
                    <div class="multi-select-menu" @onclick:stopPropagation="true">
                        <label class="multi-select-item">
                            <input type="checkbox" checked="@(filterLeads.Count == 0)" @onclick="SelectAllLeads" />
                            <span>All Leads</span>
                        </label>
                        @foreach (var lead in accountableLeads)
                        {
                            var leadName = lead;
                            <label class="multi-select-item">
                                <input type="checkbox" checked="@filterLeads.Contains(leadName)" @onclick="() => ToggleLeadFilter(leadName)" />
                                <span>@lead</span>
                            </label>
                        }
                        <div class="multi-select-actions">
                            <button type="button" class="btn btn-sm btn-primary" @onclick="CloseLeadDropdown">Done</button>
                        </div>
                    </div>
                }
            </div>
            <div style="display: flex; align-items: center;">
                <select class="form-control w-auto" @bind="groupBy">
                    <option value="Project">Projects with Resources</option>
                    <option value="None">Projects Only</option>
                    <option value="Lead">Group by Lead</option>
                    <option value="Status">Group by Status</option>
                    <option value="Theme">Group by Theme</option>
                </select>
            </div>
        </div>
        <div class="action-bar-right">
            @if (groupBy == "Project")
            {
                <button class="btn btn-secondary btn-sm" style="white-space: nowrap;" @onclick="ToggleExpandAll" aria-label="@(allExpanded ? "Collapse All" : "Expand All")">
                    @(allExpanded ? "▲ Collapse All" : "▼ Expand All")
                </button>
            }
        </div>
    </div>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th class="sortable @(GetSortClass("Name"))" @onclick='() => SetSort("Name")' aria-sort="@(DisplayHelpers.GetAriaSort(sortColumn, sortAscending, "Name"))">Project Name</th>
                    <th class="sortable @(GetSortClass("Lead"))" @onclick='() => SetSort("Lead")' aria-sort="@(DisplayHelpers.GetAriaSort(sortColumn, sortAscending, "Lead"))">Accountable Lead</th>
                    <th class="sortable @(GetSortClass("Status"))" @onclick='() => SetSort("Status")' aria-sort="@(DisplayHelpers.GetAriaSort(sortColumn, sortAscending, "Status"))">Status</th>
                    <th class="sortable @(GetSortClass("Theme"))" @onclick='() => SetSort("Theme")' aria-sort="@(DisplayHelpers.GetAriaSort(sortColumn, sortAscending, "Theme"))">Theme</th>
                    <th class="sortable @(GetSortClass("Health"))" @onclick='() => SetSort("Health")' aria-sort="@(DisplayHelpers.GetAriaSort(sortColumn, sortAscending, "Health"))">Health</th>
                    <th class="sortable @(GetSortClass("PilotDate"))" @onclick='() => SetSort("PilotDate")' aria-sort="@(DisplayHelpers.GetAriaSort(sortColumn, sortAscending, "PilotDate"))">Pilot Go-Live</th>
                    <th class="sortable @(GetSortClass("EnterpriseDate"))" @onclick='() => SetSort("EnterpriseDate")' aria-sort="@(DisplayHelpers.GetAriaSort(sortColumn, sortAscending, "EnterpriseDate"))">Enterprise Go-Live</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (groupBy == "Project")
                {
                    @foreach (var project in SortedProjects)
                    {
                        var isExpanded = expandedProjects.Contains(project.Id);
                        var hasAllocations = project.Allocations.Any();
                        <tr class="@(hasAllocations ? "project-expandable" : "") @(dropTargetProjectId == project.Id ? "drop-target" : "")"
                            ondragover="event.preventDefault();"
                            @ondragenter="() => OnDragEnter(project.Id)"
                            @ondragleave="OnDragLeave"
                            @ondrop="() => OnDrop(project.Id)">
                            <td>
                                <div class="project-name-cell">
                                    @if (hasAllocations)
                                    {
                                        <button class="expand-btn" @onclick="() => ToggleProject(project.Id)" aria-expanded="@isExpanded" aria-label="@(isExpanded ? "Collapse" : "Expand") allocations for @project.Name">
                                            @(isExpanded ? "▼" : "▶")
                                        </button>
                                    }
                                    else
                                    {
                                        <span class="expand-placeholder"></span>
                                    }
                                    <span>
                                        <strong>@project.Name</strong>
                                        @if (hasAllocations)
                                        {
                                            <span class="allocation-count">(@project.Allocations.Count)</span>
                                        }
                                    </span>
                                </div>
                            </td>
                            <td>@FormatLeadName(project.AccountableLead)</td>
                            <td>
                                @if (project.Status != null)
                                {
                                    <span class="status-badge" style="background-color: @project.Status.Color;">@project.Status.Name</span>
                                }
                                else
                                {
                                    <span class="badge badge-secondary">Not set</span>
                                }
                            </td>
                            <td>
                                @if (project.Theme != null)
                                {
                                    <span class="badge badge-primary">@project.Theme.Name</span>
                                }
                                else
                                {
                                    <span class="badge badge-secondary">Not set</span>
                                }
                            </td>
                            <td>
                                @if (project.Health != null)
                                {
                                    <span class="status-badge" style="background-color: @project.Health.Color;">@project.Health.Name</span>
                                }
                                else
                                {
                                    <span class="badge badge-secondary">Not set</span>
                                }
                            </td>
                            <td>@(project.TargetPilotGoLiveDate?.ToString("MMM dd, yyyy") ?? "-")</td>
                            <td>@(project.TargetEnterpriseGoLiveDate?.ToString("MMM dd, yyyy") ?? "-")</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" @onclick="() => OpenEditModal(project)">Edit</button>
                                <button class="btn btn-danger btn-sm" @onclick="() => ConfirmDelete(project)">Delete</button>
                            </td>
                        </tr>
                        @if (isExpanded && hasAllocations)
                        {
                            <tr class="allocation-panel-row">
                                <td colspan="8">
                                    <div class="allocation-panel">
                                        <div class="allocation-grid">
                                            @foreach (var allocation in project.Allocations.OrderBy(a => a.Resource.Name).ThenBy(a => a.StartDate))
                                            {
                                                <div class="allocation-card @(draggedAllocation?.Id == allocation.Id ? "dragging" : "")"
                                                     draggable="true"
                                                     @ondragstart="() => OnDragStart(allocation)"
                                                     @ondragend="OnDragEnd">
                                                    <span class="drag-handle">⋮⋮</span>
                                                    <span class="allocation-resource">@allocation.Resource.Name</span>
                                                    @foreach (var rr in allocation.Resource.ResourceRoles)
                                                    {
                                                        <span class="badge badge-info">@rr.Role.Name</span>
                                                    }
                                                    <span class="allocation-dates">@allocation.StartDate.ToString("MMM dd") - @allocation.EndDate.ToString("MMM dd")</span>
                                                    @if (allocation.Percentage.HasValue)
                                                    {
                                                        <span class="allocation-percentage">@allocation.Percentage%</span>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                }
                else if (groupBy == "None")
                {
                    @foreach (var project in SortedProjects)
                    {
                        @RenderProjectRow(project)
                    }
                }
                else
                {
                    @foreach (var group in GroupedProjects)
                    {
                        <tr class="group-header-row">
                            <td colspan="8">
                                <strong>@group.Key</strong>
                                <span class="group-count">(@group.Count() projects)</span>
                            </td>
                        </tr>
                        @foreach (var project in group)
                        {
                            @RenderProjectRow(project)
                        }
                    }
                }
            </tbody>
        </table>
    </div>

</div>

@if (showModal)
{
    <div class="modal-backdrop" @onclick="CloseModal">
        <div class="modal modal-wide" @onclick:stopPropagation="true" role="dialog" aria-labelledby="modal-title-project">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title-project">@(isEditing ? "Edit Project" : "Add Project")</h3>
                <button class="modal-close" @onclick="CloseModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group form-group-full">
                    <label class="form-label">Project Name *</label>
                    <input type="text" class="form-control" @bind="currentProject.Name" />
                    @if (!string.IsNullOrEmpty(projectError))
                    {
                        <div class="text-danger field-validation-error">@projectError</div>
                    }
                </div>
                <div class="form-group">
                    <label class="form-label">Accountable Lead</label>
                    <select class="form-control" @bind="currentProject.AccountableLead">
                        <option value="">Select...</option>
                        @foreach (var resource in leadResources)
                        {
                            <option value="@resource.Name">@resource.Name (@string.Join(", ", resource.ResourceRoles.Select(rr => rr.Role.Name)))</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-control" @bind="selectedStatusId">
                        <option value="0">Select status...</option>
                        @foreach (var status in statuses)
                        {
                            <option value="@status.Id">@status.Name</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Theme</label>
                    <select class="form-control" @bind="selectedThemeId">
                        <option value="0">Select theme...</option>
                        @foreach (var theme in themes)
                        {
                            <option value="@theme.Id">@theme.Name</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Health</label>
                    <select class="form-control" @bind="selectedHealthId">
                        <option value="0">Select health...</option>
                        @foreach (var health in healths)
                        {
                            <option value="@health.Id">@health.Name</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Delivery Method</label>
                    <select class="form-control" @bind="selectedDeliveryMethod">
                        <option value="">Select...</option>
                        @foreach (var method in Enum.GetValues<DeliveryMethod>())
                        {
                            <option value="@method">@DisplayHelpers.GetEnumDisplayName(method)</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <select class="form-control" @bind="selectedPriority">
                        <option value="">Select...</option>
                        @foreach (var priority in Enum.GetValues<Priority>())
                        {
                            <option value="@priority">@DisplayHelpers.GetEnumDisplayName(priority)</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Target Pilot Go-Live Date</label>
                    <input type="date" class="form-control" @bind="selectedPilotDate" @bind:format="yyyy-MM-dd" />
                </div>
                <div class="form-group">
                    <label class="form-label">Target Enterprise Go-Live Date</label>
                    <input type="date" class="form-control" @bind="selectedEnterpriseDate" @bind:format="yyyy-MM-dd" />
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                <button class="btn btn-primary" @onclick="SaveProject">Save</button>
            </div>
        </div>
    </div>
}

@if (showMoveModal && allocationToMove != null)
{
    <div class="modal-backdrop" @onclick="CloseMoveModal">
        <div class="modal" @onclick:stopPropagation="true" role="dialog" aria-labelledby="modal-title-move">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title-move">Move Allocation</h3>
                <button class="modal-close" @onclick="CloseMoveModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="move-summary">
                    <p>Moving <strong>@allocationToMove.Resource.Name</strong> (@string.Join(", ", allocationToMove.Resource.ResourceRoles.Select(rr => rr.Role.Name)))</p>
                    <p class="move-direction">
                        <span class="from-project">@allocationToMove.Project.Name</span>
                        <span class="move-arrow">→</span>
                        <span class="to-project">@targetProjectName</span>
                    </p>
                    <p class="period-info">@allocationToMove.StartDate.ToString("MMM dd, yyyy") - @allocationToMove.EndDate.ToString("MMM dd, yyyy")</p>
                </div>

                @if (hasExistingRoleConflict)
                {
                    <div class="role-conflict-warning">
                        <span class="warning-icon">⚠️</span>
                        <div class="warning-content">
                            <strong>@conflictRoleName already exists</strong>
                            <p><strong>@existingRoleHolder</strong> is already assigned as @conflictRoleName for this project in the same period.</p>
                            <p>Do you want to add another @conflictRoleName to this project?</p>
                        </div>
                    </div>
                }

                <div class="form-group">
                    <label class="form-label">Capacity</label>
                    <div class="capacity-options">
                        <label class="radio-option">
                            <input type="radio" name="capacityOption" checked="@keepSameCapacity" @onchange="() => keepSameCapacity = true" />
                            <span>Keep same capacity (@(allocationToMove.Percentage.HasValue ? $"{allocationToMove.Percentage}%" : "N/A"))</span>
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="capacityOption" checked="@(!keepSameCapacity)" @onchange="() => keepSameCapacity = false" />
                            <span>Change capacity</span>
                        </label>
                    </div>
                </div>

                @if (!keepSameCapacity)
                {
                    <div class="form-group">
                        <label class="form-label">New Capacity (%)</label>
                        <input type="number" class="form-control" min="0" max="100" @bind="newPercentage" placeholder="Enter percentage..." />
                    </div>
                }
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" @onclick="CloseMoveModal">Cancel</button>
                <button class="btn btn-primary" @onclick="ConfirmMove">Move</button>
            </div>
        </div>
    </div>
}

<ConfirmDeleteModal Visible="showDeleteConfirm"
    Message="@($"Are you sure you want to delete project \"{projectToDelete?.Name}\"? This will also delete all its allocations.")"
    OnConfirm="DeleteProject"
    OnCancel="CancelDelete" />

@code {
    private bool showDeleteConfirm = false;
    private Project? projectToDelete = null;

    private RenderFragment RenderProjectRow(Project project) => __builder =>
    {
        <tr>
            <td><strong>@project.Name</strong></td>
            <td>@FormatLeadName(project.AccountableLead)</td>
            <td>
                @if (project.Status != null)
                {
                    <span class="status-badge" style="background-color: @project.Status.Color;">@project.Status.Name</span>
                }
                else
                {
                    <span class="badge badge-secondary">Not set</span>
                }
            </td>
            <td>
                @if (project.Theme != null)
                {
                    <span class="badge badge-primary">@project.Theme.Name</span>
                }
                else
                {
                    <span class="badge badge-secondary">Not set</span>
                }
            </td>
            <td>
                @if (project.Health != null)
                {
                    <span class="status-badge" style="background-color: @project.Health.Color;">@project.Health.Name</span>
                }
                else
                {
                    <span class="badge badge-secondary">Not set</span>
                }
            </td>
            <td>@(project.TargetPilotGoLiveDate?.ToString("MMM dd, yyyy") ?? "-")</td>
            <td>@(project.TargetEnterpriseGoLiveDate?.ToString("MMM dd, yyyy") ?? "-")</td>
            <td>
                <button class="btn btn-secondary btn-sm" @onclick="() => OpenEditModal(project)">Edit</button>
                <button class="btn btn-danger btn-sm" @onclick="() => ConfirmDelete(project)">Delete</button>
            </td>
        </tr>
    };

    private List<Project> projects = new();
    private List<ProjectStatus> statuses = new();
    private List<Theme> themes = new();
    private List<ProjectHealth> healths = new();
    private List<Resource> leadResources = new();
    private string searchTerm = "";
    private HashSet<int> filterStatusIds = new();
    private HashSet<string> filterLeads = new();
    private List<string> accountableLeads = new();
    private bool showStatusDropdown = false;
    private bool showLeadDropdown = false;
    private bool showModal = false;
    private string groupBy = "Project";
    private HashSet<int> expandedProjects = new();
    private Allocation? draggedAllocation = null;
    private int? dropTargetProjectId = null;
    private bool showMoveModal = false;
    private string? projectError = null;
    private Allocation? allocationToMove = null;
    private int targetProjectIdForMove = 0;
    private string targetProjectName = "";
    private int? newPercentage = null;
    private bool keepSameCapacity = true;
    private bool hasExistingRoleConflict = false;
    private string existingRoleHolder = "";
    private string conflictRoleName = "";
    private bool isEditing = false;
    private Project currentProject = new();
    private string selectedDeliveryMethod = "";
    private string selectedPriority = "";
    private int selectedStatusId = 0;
    private int selectedThemeId = 0;
    private int selectedHealthId = 0;
    private DateTime? selectedPilotDate;
    private DateTime? selectedEnterpriseDate;

    // Sorting
    private string sortColumn = "Name";
    private bool sortAscending = true;

    private IEnumerable<Project> FilteredProjects
    {
        get
        {
            var filtered = projects.AsEnumerable();

            if (!string.IsNullOrWhiteSpace(searchTerm))
                filtered = filtered.Where(p => p.Name.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ||
                                              (p.AccountableLead?.Contains(searchTerm, StringComparison.OrdinalIgnoreCase) ?? false));

            if (filterStatusIds.Count > 0)
                filtered = filtered.Where(p => p.StatusId.HasValue && filterStatusIds.Contains(p.StatusId.Value));

            if (filterLeads.Count > 0)
                filtered = filtered.Where(p => p.AccountableLead != null && filterLeads.Contains(p.AccountableLead));

            return filtered;
        }
    }

    private IEnumerable<Project> SortedProjects
    {
        get
        {
            var data = FilteredProjects;
            return sortColumn switch
            {
                "Name" => sortAscending ? data.OrderBy(p => p.Name) : data.OrderByDescending(p => p.Name),
                "Status" => sortAscending ? data.OrderBy(p => p.Status?.DisplayOrder ?? int.MaxValue) : data.OrderByDescending(p => p.Status?.DisplayOrder ?? 0),
                "Theme" => sortAscending ? data.OrderBy(p => p.Theme?.Name ?? "zzz") : data.OrderByDescending(p => p.Theme?.Name ?? ""),
                "Health" => sortAscending ? data.OrderBy(p => p.Health?.DisplayOrder ?? int.MaxValue) : data.OrderByDescending(p => p.Health?.DisplayOrder ?? 0),
                "Lead" => sortAscending ? data.OrderBy(p => p.AccountableLead ?? "zzz") : data.OrderByDescending(p => p.AccountableLead ?? ""),
                "Method" => sortAscending ? data.OrderBy(p => p.DeliveryMethod?.ToString() ?? "zzz") : data.OrderByDescending(p => p.DeliveryMethod?.ToString() ?? ""),
                "Priority" => sortAscending ? data.OrderBy(p => (int?)p.Priority ?? int.MaxValue) : data.OrderByDescending(p => (int?)p.Priority ?? int.MinValue),
                "PilotDate" => sortAscending ? data.OrderBy(p => p.TargetPilotGoLiveDate ?? DateTime.MaxValue) : data.OrderByDescending(p => p.TargetPilotGoLiveDate ?? DateTime.MinValue),
                "EnterpriseDate" => sortAscending ? data.OrderBy(p => p.TargetEnterpriseGoLiveDate ?? DateTime.MaxValue) : data.OrderByDescending(p => p.TargetEnterpriseGoLiveDate ?? DateTime.MinValue),
                _ => data.OrderBy(p => p.Name)
            };
        }
    }

    private IEnumerable<IGrouping<string, Project>> GroupedProjects
    {
        get
        {
            var data = SortedProjects;
            return groupBy switch
            {
                "Lead" => data.GroupBy(p => p.AccountableLead ?? "No Lead"),
                "Status" => data.GroupBy(p => p.Status?.Name ?? "No Status"),
                "Theme" => data.GroupBy(p => p.Theme?.Name ?? "No Theme"),
                _ => data.GroupBy(p => "All")
            };
        }
    }

    private void SetSort(string column)
    {
        if (sortColumn == column)
            sortAscending = !sortAscending;
        else
        {
            sortColumn = column;
            sortAscending = true;
        }
    }

    private string GetSortClass(string column) => sortColumn == column ? (sortAscending ? "asc" : "desc") : "";

    private static readonly string[] LeadRoleNames = { "product owner", "scrum master", "ba" };

    protected override async Task OnInitializedAsync()
    {
        statuses = await DbContext.ProjectStatuses.OrderBy(s => s.DisplayOrder).ToListAsync();
        themes = await DbContext.Themes.OrderBy(t => t.Name).ToListAsync();
        healths = await DbContext.ProjectHealths.OrderBy(h => h.DisplayOrder).ToListAsync();
        await LoadLeadResources();
        await LoadProjects();
    }

    private async Task LoadLeadResources()
    {
        leadResources = await DbContext.Resources
            .Include(r => r.ResourceRoles).ThenInclude(rr => rr.Role)
            .Where(r => r.ResourceRoles.Any(rr => LeadRoleNames.Contains(rr.Role.Name.ToLower())))
            .OrderBy(r => r.Name)
            .ToListAsync();
    }

    private async Task LoadProjects()
    {
        projects = await DbContext.Projects
            .Include(p => p.Status)
            .Include(p => p.Theme)
            .Include(p => p.Health)
            .Include(p => p.Allocations)
                .ThenInclude(a => a.Resource)
                    .ThenInclude(r => r.ResourceRoles)
                        .ThenInclude(rr => rr.Role)
            .OrderBy(p => p.Name)
            .ToListAsync();
        accountableLeads = projects
            .Where(p => !string.IsNullOrWhiteSpace(p.AccountableLead))
            .Select(p => p.AccountableLead!)
            .Distinct()
            .OrderBy(l => l)
            .ToList();
    }

    private void OpenAddModal()
    {
        currentProject = new Project();
        selectedDeliveryMethod = "";
        selectedPriority = "";
        selectedStatusId = 0;
        selectedThemeId = 0;
        selectedHealthId = 0;
        selectedPilotDate = null;
        selectedEnterpriseDate = null;
        isEditing = false;
        projectError = null;
        showModal = true;
    }

    private void OpenEditModal(Project project)
    {
        currentProject = new Project
        {
            Id = project.Id,
            Name = project.Name,
            AccountableLead = project.AccountableLead,
            DeliveryMethod = project.DeliveryMethod,
            Priority = project.Priority,
            StatusId = project.StatusId,
            ThemeId = project.ThemeId,
            HealthId = project.HealthId,
            TargetPilotGoLiveDate = project.TargetPilotGoLiveDate,
            TargetEnterpriseGoLiveDate = project.TargetEnterpriseGoLiveDate
        };
        selectedDeliveryMethod = project.DeliveryMethod?.ToString() ?? "";
        selectedPriority = project.Priority?.ToString() ?? "";
        selectedStatusId = project.StatusId ?? 0;
        selectedThemeId = project.ThemeId ?? 0;
        selectedHealthId = project.HealthId ?? 0;
        selectedPilotDate = project.TargetPilotGoLiveDate;
        selectedEnterpriseDate = project.TargetEnterpriseGoLiveDate;
        isEditing = true;
        projectError = null;
        showModal = true;
    }

    private void CloseModal()
    {
        projectError = null;
        showModal = false;
    }

    private async Task SaveProject()
    {
        projectError = null;
        if (string.IsNullOrWhiteSpace(currentProject.Name))
            return;

        var nameToCheck = currentProject.Name.Trim().ToLower();
        var duplicate = await DbContext.Projects
            .AnyAsync(p => p.Name.ToLower() == nameToCheck && (!isEditing || p.Id != currentProject.Id));
        if (duplicate)
        {
            projectError = "A project with this name already exists.";
            return;
        }

        currentProject.DeliveryMethod = string.IsNullOrEmpty(selectedDeliveryMethod)
            ? null
            : Enum.Parse<DeliveryMethod>(selectedDeliveryMethod);
        currentProject.Priority = string.IsNullOrEmpty(selectedPriority)
            ? null
            : Enum.Parse<Priority>(selectedPriority);
        currentProject.StatusId = selectedStatusId == 0 ? null : selectedStatusId;
        currentProject.ThemeId = selectedThemeId == 0 ? null : selectedThemeId;
        currentProject.HealthId = selectedHealthId == 0 ? null : selectedHealthId;
        currentProject.TargetPilotGoLiveDate = selectedPilotDate;
        currentProject.TargetEnterpriseGoLiveDate = selectedEnterpriseDate;

        if (isEditing)
        {
            var existing = await DbContext.Projects.FindAsync(currentProject.Id);
            if (existing != null)
            {
                existing.Name = currentProject.Name;
                existing.AccountableLead = currentProject.AccountableLead;
                existing.DeliveryMethod = currentProject.DeliveryMethod;
                existing.Priority = currentProject.Priority;
                existing.StatusId = currentProject.StatusId;
                existing.ThemeId = currentProject.ThemeId;
                existing.HealthId = currentProject.HealthId;
                existing.TargetPilotGoLiveDate = currentProject.TargetPilotGoLiveDate;
                existing.TargetEnterpriseGoLiveDate = currentProject.TargetEnterpriseGoLiveDate;
                await DbContext.SaveChangesAsync();
            }
        }
        else
        {
            DbContext.Projects.Add(currentProject);
            await DbContext.SaveChangesAsync();
        }

        await LoadProjects();
        CloseModal();
    }

    private void ConfirmDelete(Project project)
    {
        projectToDelete = project;
        showDeleteConfirm = true;
    }

    private void CancelDelete()
    {
        projectToDelete = null;
        showDeleteConfirm = false;
    }

    private async Task DeleteProject()
    {
        if (projectToDelete == null) return;
        DbContext.Projects.Remove(projectToDelete);
        await DbContext.SaveChangesAsync();
        projectToDelete = null;
        showDeleteConfirm = false;
        await LoadProjects();
    }

    private string GetPriorityClass(Priority priority) => priority switch
    {
        Priority.High => "badge-danger",
        Priority.Medium => "badge-warning",
        Priority.Low => "badge-success",
        _ => "badge-secondary"
    };

    private string FormatLeadName(string? fullName)
    {
        if (string.IsNullOrWhiteSpace(fullName)) return "-";
        var parts = fullName.Trim().Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length < 2) return parts[0];
        return $"{parts[0]} {parts[^1][0]}.";
    }

    private void ToggleStatusDropdown()
    {
        showStatusDropdown = !showStatusDropdown;
        if (showStatusDropdown) showLeadDropdown = false;
    }

    private void CloseStatusDropdown() => showStatusDropdown = false;

    private void CloseAllDropdowns()
    {
        showStatusDropdown = false;
        showLeadDropdown = false;
    }

    private void ToggleStatusFilter(int statusId)
    {
        if (filterStatusIds.Contains(statusId))
            filterStatusIds.Remove(statusId);
        else
            filterStatusIds.Add(statusId);
    }

    private void SelectAllStatuses()
    {
        filterStatusIds.Clear();
    }

    private string GetStatusFilterLabel()
    {
        if (filterStatusIds.Count == 0)
            return "All Statuses";
        if (filterStatusIds.Count == 1)
            return statuses.FirstOrDefault(s => s.Id == filterStatusIds.First())?.Name ?? "1 selected";
        return $"{filterStatusIds.Count} selected";
    }

    private void ToggleLeadDropdown()
    {
        showLeadDropdown = !showLeadDropdown;
        if (showLeadDropdown) showStatusDropdown = false;
    }

    private void CloseLeadDropdown() => showLeadDropdown = false;

    private void ToggleLeadFilter(string lead)
    {
        if (filterLeads.Contains(lead))
            filterLeads.Remove(lead);
        else
            filterLeads.Add(lead);
    }

    private void SelectAllLeads()
    {
        filterLeads.Clear();
    }

    private string GetLeadFilterLabel()
    {
        if (filterLeads.Count == 0)
            return "All Leads";
        if (filterLeads.Count == 1)
            return filterLeads.First();
        return $"{filterLeads.Count} selected";
    }

    private void ToggleProject(int projectId)
    {
        if (expandedProjects.Contains(projectId))
            expandedProjects.Remove(projectId);
        else
            expandedProjects.Add(projectId);
    }

    private bool allExpanded = false;

    private void ToggleExpandAll()
    {
        if (allExpanded)
        {
            expandedProjects.Clear();
        }
        else
        {
            foreach (var project in SortedProjects.Where(p => p.Allocations.Any()))
            {
                expandedProjects.Add(project.Id);
            }
        }
        allExpanded = !allExpanded;
    }

    // Drag and Drop handlers
    private void OnDragStart(Allocation allocation)
    {
        draggedAllocation = allocation;
    }

    private void OnDragEnd()
    {
        draggedAllocation = null;
        dropTargetProjectId = null;
    }

    private void OnDragEnter(int projectId)
    {
        if (draggedAllocation != null && draggedAllocation.ProjectId != projectId)
        {
            dropTargetProjectId = projectId;
        }
    }

    private void OnDragLeave()
    {
        dropTargetProjectId = null;
    }

    private void OnDrop(int targetProjectId)
    {
        if (draggedAllocation == null || draggedAllocation.ProjectId == targetProjectId)
        {
            dropTargetProjectId = null;
            draggedAllocation = null;
            return;
        }

        // Store info for the modal
        allocationToMove = draggedAllocation;
        targetProjectIdForMove = targetProjectId;
        targetProjectName = projects.FirstOrDefault(p => p.Id == targetProjectId)?.Name ?? "Unknown";
        newPercentage = draggedAllocation.Percentage;
        keepSameCapacity = true;

        // Check for existing SM or PO in target project for overlapping date range
        hasExistingRoleConflict = false;
        existingRoleHolder = "";
        conflictRoleName = "";

        var draggedRoleNames = draggedAllocation.Resource.ResourceRoles.Select(rr => rr.Role.Name).ToList();
        var targetProject2 = projects.FirstOrDefault(p => p.Id == targetProjectId);
        if (targetProject2 != null)
        {
            foreach (var roleName in draggedRoleNames.Where(n => n == "Scrum Master" || n == "Product Owner"))
            {
                var existingAllocation = targetProject2.Allocations
                    .FirstOrDefault(a => a.Resource.ResourceRoles.Any(rr => rr.Role.Name == roleName) &&
                                        a.StartDate <= draggedAllocation.EndDate &&
                                        a.EndDate >= draggedAllocation.StartDate);

                if (existingAllocation != null)
                {
                    hasExistingRoleConflict = true;
                    existingRoleHolder = existingAllocation.Resource.Name;
                    conflictRoleName = roleName;
                    break;
                }
            }
        }

        showMoveModal = true;
        dropTargetProjectId = null;
        draggedAllocation = null;
    }

    private void CloseMoveModal()
    {
        showMoveModal = false;
        allocationToMove = null;
        targetProjectIdForMove = 0;
        targetProjectName = "";
        newPercentage = null;
        keepSameCapacity = true;
        hasExistingRoleConflict = false;
        existingRoleHolder = "";
        conflictRoleName = "";
    }

    private async Task ConfirmMove()
    {
        if (allocationToMove == null)
        {
            CloseMoveModal();
            return;
        }

        var allocation = await DbContext.Allocations.FindAsync(allocationToMove.Id);
        if (allocation != null)
        {
            allocation.ProjectId = targetProjectIdForMove;

            if (!keepSameCapacity)
            {
                allocation.Percentage = newPercentage;
            }

            await DbContext.SaveChangesAsync();
            await LoadProjects();

            // Keep target project expanded to show the moved allocation
            expandedProjects.Add(targetProjectIdForMove);
        }

        CloseMoveModal();
    }
}
